

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Program Listing for File FlowContourMatch.cxx &mdash; larflow 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script type="text/javascript" src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> larflow
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="library_root.html">Library API</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">larflow</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Program Listing for File FlowContourMatch.cxx</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/api/program_listing_file_larflow_FlowContourMatch_arxiv_FlowContourMatch.cxx.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="program-listing-for-file-flowcontourmatch-cxx">
<span id="program-listing-file-larflow-flowcontourmatch-arxiv-flowcontourmatch-cxx"></span><h1>Program Listing for File FlowContourMatch.cxx<a class="headerlink" href="#program-listing-for-file-flowcontourmatch-cxx" title="Permalink to this headline">¶</a></h1>
<p>↰ <a class="reference internal" href="file_larflow_FlowContourMatch_arxiv_FlowContourMatch.cxx.html#file-larflow-flowcontourmatch-arxiv-flowcontourmatch-cxx"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">larflow/FlowContourMatch/arxiv/FlowContourMatch.cxx</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;FlowContourMatch.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;exception&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cmath&gt;</span><span class="cp"></span>

<span class="c1">// larlite</span>
<span class="cp">#include</span> <span class="cpf">&quot;LArUtil/Geometry.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;LArUtil/LArProperties.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;LArUtil/DetectorProperties.h&quot;</span><span class="cp"></span>

<span class="c1">// larcv</span>
<span class="cp">#include</span> <span class="cpf">&quot;larcv/core/DataFormat/ImageMeta.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;larcv/core/ROOTUtil/ROOTUtils.h&quot;</span><span class="cp"></span>

<span class="c1">// ROOT</span>
<span class="cp">#include</span> <span class="cpf">&quot;TStyle.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;TCanvas.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;TH2D.h&quot;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">larflow</span> <span class="p">{</span>


  <span class="n">FlowMatchData_t</span><span class="o">::</span><span class="n">FlowMatchData_t</span><span class="p">(</span> <span class="kt">int</span> <span class="n">srcid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tarid</span> <span class="p">)</span>
    <span class="o">:</span> <span class="n">src_ctr_id</span><span class="p">(</span><span class="n">srcid</span><span class="p">),</span> <span class="n">tar_ctr_id</span><span class="p">(</span><span class="n">tarid</span><span class="p">),</span> <span class="n">score</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">{}</span>
  <span class="n">FlowMatchData_t</span><span class="o">::</span><span class="n">FlowMatchData_t</span><span class="p">(</span> <span class="k">const</span> <span class="n">FlowMatchData_t</span><span class="o">&amp;</span> <span class="n">x</span> <span class="p">)</span>
    <span class="o">:</span> <span class="n">src_ctr_id</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">src_ctr_id</span><span class="p">),</span>
      <span class="n">tar_ctr_id</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">tar_ctr_id</span><span class="p">),</span>
      <span class="n">score</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">score</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">matchingflow_v</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">matchingflow_v</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// ==========================================</span>
  <span class="c1">// FlowContourMatch Algo</span>
  <span class="c1">// ---------------------</span>

  <span class="k">const</span> <span class="kt">int</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">kSourcePlane</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">};</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">kTargetPlane</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>

  <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">FlowContourMatch</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">m_plot_scorematrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">m_tar_img2ctrindex</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">m_src_img2ctrindex</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// parameters: see header for descriptions</span>
    <span class="n">kTargetChargeRadius</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="c1">// larutil</span>
    <span class="n">m_psce</span> <span class="o">=</span> <span class="k">new</span> <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">SpaceChargeMicroBooNE</span><span class="p">;</span>
    <span class="n">m_ptsv</span> <span class="o">=</span> <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">TimeService</span><span class="o">::</span><span class="n">GetME</span><span class="p">();</span>

  <span class="p">}</span>

  <span class="n">FlowContourMatch</span><span class="o">::~</span><span class="n">FlowContourMatch</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">clear</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">clear</span><span class="p">(</span> <span class="kt">bool</span> <span class="n">clear2d</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">clear3d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flowdir</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">clear2d</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// needs to be cleared for each subimage (entry)</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">flowdir</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">!=</span><span class="n">flowdir</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

    <span class="k">delete</span> <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">delete</span> <span class="n">m_plot_scorematrix</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="n">m_plot_scorematrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="n">m_flowdata</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clear</span><span class="p">();</span>
        <span class="n">m_flowdata_indexmap</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">m_src_targets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clear</span><span class="p">();</span>
    <span class="k">delete</span> <span class="n">m_tar_img2ctrindex</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">m_tar_img2ctrindex</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">delete</span> <span class="n">m_src_img2ctrindex</span><span class="p">;</span>
      <span class="n">m_src_img2ctrindex</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="p">}</span><span class="c1">//end of clear 2nd</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">clear3d</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// needs to be cleared after every event</span>
      <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// ==================================================================================</span>
  <span class="c1">// Main function</span>
  <span class="c1">// -----------------------</span>

  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">&gt;</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">makeFlowPixels</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;&amp;</span> <span class="n">adc_crop_v</span><span class="p">,</span>
                                                                       <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">SparseImage</span><span class="o">&gt;&amp;</span> <span class="n">flowy2u</span><span class="p">,</span>
                                                                       <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">SparseImage</span><span class="o">&gt;&amp;</span> <span class="n">flowy2v</span><span class="p">,</span>
                                                                       <span class="k">const</span> <span class="kt">float</span> <span class="n">threshold</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">&gt;</span> <span class="n">flowhit_v</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">flowhit_v</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="c1">// ==================================================================================</span>
  <span class="c1">// Primary Interfaces</span>
  <span class="c1">// -----------------------</span>
  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">fillPlaneHitFlow</span><span class="p">(</span> <span class="k">const</span> <span class="n">ublarcvapp</span><span class="o">::</span><span class="n">ContourClusterAlgo</span><span class="o">&amp;</span> <span class="n">contour_data</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">src_adc</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;&amp;</span> <span class="n">tar_adc</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;&amp;</span> <span class="n">flow_img</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">larlite</span><span class="o">::</span><span class="n">event_hit</span><span class="o">&amp;</span> <span class="n">hit_v</span><span class="p">,</span>
                       <span class="k">const</span> <span class="kt">float</span> <span class="n">threshold</span><span class="p">,</span>
                       <span class="kt">bool</span> <span class="n">runY2U</span><span class="p">,</span>
                       <span class="kt">bool</span> <span class="n">runY2V</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Primary call.</span>
    <span class="c1">// We expect this to be called many time per event, for each subimage</span>
    <span class="c1">// goal is to fill m_plhit2flowdata</span>

    <span class="c1">// we clear 2d info only (first). 3d info gets accumulated over many subimages</span>
    <span class="c1">// this is wonky and needs to get fixed with eventual interface where whole-image gets provided</span>
    <span class="c1">// (or vector of subimages? -- lots of mem to hold that simultaneously?)</span>
    <span class="n">clear</span><span class="p">(</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span> <span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">runY2U</span> <span class="o">&amp;&amp;</span> <span class="n">runY2V</span> <span class="o">&amp;&amp;</span> <span class="n">tar_adc</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">){</span>
      <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;FlowContourMatch::fillPlaneHitFlow: requested both planes but single target&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">runY2U</span> <span class="o">&amp;&amp;</span> <span class="n">runY2V</span> <span class="o">&amp;&amp;</span> <span class="n">flow_img</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">){</span>
      <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;FlowContourMatch::fillPlaneHitFlow: requested both planes but single flow image&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">runY2U</span><span class="p">){</span>
      <span class="c1">//std::cout &lt;&lt; &quot;Run Y2U Match&quot; &lt;&lt; std::endl;</span>
      <span class="n">_match</span><span class="p">(</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">kY2U</span><span class="p">,</span>
         <span class="n">contour_data</span><span class="p">,</span>
         <span class="n">src_adc</span><span class="p">,</span>
         <span class="n">tar_adc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
         <span class="n">flow_img</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
         <span class="n">hit_v</span><span class="p">,</span>
         <span class="n">threshold</span> <span class="p">);</span>

      <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">ranY2U</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">runY2V</span><span class="p">){</span>
      <span class="c1">//std::cout &lt;&lt; &quot;Run Y2V Match&quot; &lt;&lt; std::endl;</span>
      <span class="n">_match</span><span class="p">(</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">kY2V</span><span class="p">,</span>
          <span class="n">contour_data</span><span class="p">,</span>
          <span class="n">src_adc</span><span class="p">,</span>
          <span class="n">tar_adc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
          <span class="n">flow_img</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
          <span class="n">hit_v</span><span class="p">,</span>
          <span class="n">threshold</span> <span class="p">);</span>

      <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">ranY2V</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//check for size mismatch: should not happen if both run</span>
    <span class="k">if</span><span class="p">(</span><span class="n">runY2U</span> <span class="o">&amp;&amp;</span> <span class="n">runY2V</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">Y2U</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">Y2V</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">)</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;FlowContourMatch::fillPlaneHitFlowData -- Y2U and Y2V do not match&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">_fill_consistency3d</span><span class="p">(</span><span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">Y2U</span><span class="p">,</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">Y2V</span><span class="p">,</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">consistency3d</span><span class="p">,</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">dy</span><span class="p">,</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">dz</span><span class="p">);</span>

  <span class="p">}</span>


  <span class="c1">// =====================================================================</span>
  <span class="c1">// SSNet+Endpoint Integration</span>
  <span class="c1">// ---------------------------</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">integrateSSNetEndpointOutput</span><span class="p">(</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;&amp;</span> <span class="n">track_scoreimgs</span><span class="p">,</span>
                               <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;&amp;</span> <span class="n">shower_scoreimgs</span><span class="p">,</span>
                               <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;&amp;</span> <span class="n">endpt_scoreimgs</span> <span class="p">)</span>
  <span class="p">{</span>

    <span class="c1">// store ssnet+endpoint information into hit2flow data</span>
    <span class="c1">// inputs</span>
    <span class="c1">// ------</span>
    <span class="c1">// track_scoreimgs: assuming vector is (u,v,y)</span>
    <span class="c1">// shower_scoreimgs: assuming vector is (u,v,y)</span>
    <span class="c1">// endpt_scoreimgs: assuming vector is (u,v,y)</span>
    <span class="c1">// ** we assume the above cover the same subimage region</span>
    <span class="c1">//</span>
    <span class="c1">// output</span>
    <span class="c1">// -------</span>
    <span class="c1">// updates m_plhit2flowdata[Y2U and Y2V] (if exists)</span>

    <span class="c1">// can be whole view or subimage</span>
    <span class="c1">// we loop over hits, and check if image set is applicable</span>

    <span class="kt">bool</span> <span class="n">filled</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">ranY2U</span><span class="p">,</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">ranY2V</span> <span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;*</span> <span class="n">phitdata_v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">Y2U</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">Y2V</span><span class="p">)</span> <span class="p">};</span>

    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">iflow</span><span class="o">=</span><span class="n">kY2U</span><span class="p">;</span> <span class="n">iflow</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kNumFlowDirs</span><span class="p">;</span> <span class="n">iflow</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">filled</span><span class="p">[</span><span class="n">iflow</span><span class="p">]</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;&amp;</span>  <span class="n">hitdata_v</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">phitdata_v</span><span class="p">[</span><span class="n">iflow</span><span class="p">]);</span>

      <span class="c1">// we check if hit is contained</span>
      <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">track_img</span>  <span class="o">=</span> <span class="n">track_scoreimgs</span><span class="p">[</span>  <span class="n">kSourcePlane</span><span class="p">[</span><span class="n">iflow</span><span class="p">]</span> <span class="p">];</span>
      <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">shower_img</span> <span class="o">=</span> <span class="n">shower_scoreimgs</span><span class="p">[</span> <span class="n">kSourcePlane</span><span class="p">[</span><span class="n">iflow</span><span class="p">]</span> <span class="p">];</span>
      <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">endpt_img</span>  <span class="o">=</span> <span class="n">endpt_scoreimgs</span><span class="p">[</span>  <span class="n">kSourcePlane</span><span class="p">[</span><span class="n">iflow</span><span class="p">]</span> <span class="p">];</span>
      <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">ImageMeta</span><span class="o">&amp;</span> <span class="n">track_meta</span> <span class="o">=</span> <span class="n">track_img</span><span class="p">.</span><span class="n">meta</span><span class="p">();</span>

      <span class="k">for</span> <span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">hitdata</span> <span class="p">:</span> <span class="n">hitdata_v</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">track_meta</span><span class="p">.</span><span class="n">min_x</span><span class="p">()</span><span class="o">&lt;=</span><span class="n">hitdata</span><span class="p">.</span><span class="n">srcwire</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">srcwire</span><span class="o">&lt;</span><span class="n">track_meta</span><span class="p">.</span><span class="n">max_x</span><span class="p">()</span>
         <span class="o">&amp;&amp;</span> <span class="n">track_meta</span><span class="p">.</span><span class="n">min_y</span><span class="p">()</span><span class="o">&lt;=</span><span class="n">hitdata</span><span class="p">.</span><span class="n">pixtick</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">pixtick</span><span class="o">&lt;</span><span class="n">track_meta</span><span class="p">.</span><span class="n">max_y</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// inside image</span>

      <span class="kt">int</span> <span class="n">col</span> <span class="o">=</span> <span class="n">track_meta</span><span class="p">.</span><span class="n">col</span><span class="p">(</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">srcwire</span> <span class="p">);</span>
      <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">track_meta</span><span class="p">.</span><span class="n">row</span><span class="p">(</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">pixtick</span> <span class="p">);</span>
      <span class="n">hitdata</span><span class="p">.</span><span class="n">track_score</span>  <span class="o">=</span> <span class="n">track_img</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">);</span>
      <span class="n">hitdata</span><span class="p">.</span><span class="n">shower_score</span> <span class="o">=</span> <span class="n">shower_img</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">);</span>
      <span class="n">hitdata</span><span class="p">.</span><span class="n">endpt_score</span>  <span class="o">=</span> <span class="n">endpt_img</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">);</span>

      <span class="c1">// renormed scores: remove endpt and recalc shower/track</span>
      <span class="kt">float</span> <span class="n">renorm</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">endpt_score</span><span class="p">;</span> <span class="c1">// bg+track+shower</span>
      <span class="n">hitdata</span><span class="p">.</span><span class="n">renormed_track_score</span>  <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">track_score</span><span class="o">/</span><span class="n">renorm</span><span class="p">;</span>
      <span class="n">hitdata</span><span class="p">.</span><span class="n">renormed_shower_score</span> <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">shower_score</span><span class="o">/</span><span class="n">renorm</span><span class="p">;</span>

    <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// =====================================================================</span>
  <span class="c1">// INFILL INTEGRATION</span>
  <span class="c1">// --------------------</span>
  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">stitchInfill</span><span class="p">(</span> <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">infill_crop</span><span class="p">,</span>
                       <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">trusted</span><span class="p">,</span>
                       <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">infill_whole</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">EventChStatus</span><span class="o">&amp;</span> <span class="n">ev_chstatus</span><span class="p">){</span>

    <span class="c1">// fills an infill subimage in a whole image.</span>
    <span class="c1">// Note: this is set to prefer prediction in center of image.</span>

    <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">ImageMeta</span><span class="o">&amp;</span> <span class="n">out_meta</span> <span class="o">=</span> <span class="n">infill_whole</span><span class="p">.</span><span class="n">meta</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">src_min_c</span> <span class="o">=</span> <span class="n">out_meta</span><span class="p">.</span><span class="n">col</span><span class="p">(</span> <span class="n">infill_crop</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">min_x</span><span class="p">()</span> <span class="p">);</span>
    <span class="kt">int</span> <span class="n">src_min_r</span> <span class="o">=</span> <span class="n">out_meta</span><span class="p">.</span><span class="n">row</span><span class="p">(</span> <span class="n">infill_crop</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">min_y</span><span class="p">()</span> <span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">r</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">infill_crop</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">rows</span><span class="p">();</span> <span class="n">r</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">c</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">infill_crop</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">cols</span><span class="p">();</span> <span class="n">c</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="n">src_c</span> <span class="o">=</span> <span class="n">src_min_c</span><span class="o">+</span><span class="n">c</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">src_r</span> <span class="o">=</span> <span class="n">src_min_r</span><span class="o">+</span><span class="n">r</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">trusted</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span><span class="n">src_r</span><span class="p">,</span><span class="n">src_c</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">)</span>
      <span class="k">continue</span><span class="p">;</span> <span class="c1">// already filled by trusted region</span>

    <span class="n">infill_whole</span><span class="p">.</span><span class="n">set_pixel</span><span class="p">(</span> <span class="n">src_r</span><span class="p">,</span> <span class="n">src_c</span><span class="p">,</span> <span class="n">infill_crop</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">c</span><span class="o">&gt;=</span><span class="mi">261</span> <span class="o">||</span> <span class="n">c</span><span class="o">&lt;=</span><span class="mi">571</span> <span class="p">)</span>
      <span class="n">trusted</span><span class="p">.</span><span class="n">set_pixel</span><span class="p">(</span> <span class="n">src_r</span><span class="p">,</span> <span class="n">src_c</span><span class="p">,</span> <span class="mf">1.0</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">maskInfill</span><span class="p">(</span> <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">infill</span><span class="p">,</span>
                     <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">EventChStatus</span><span class="o">&amp;</span> <span class="n">ev_chstatus</span><span class="p">,</span>
                     <span class="k">const</span> <span class="kt">float</span> <span class="n">score_thresh</span><span class="p">,</span>
                     <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">masked_infill</span><span class="p">){</span>
    <span class="c1">// masks infill prediction outside of dead regions.</span>
    <span class="c1">// creates activation image (pix = 0 or 1) w.r.t. infill score threshold</span>
    <span class="c1">// inputs</span>
    <span class="c1">//------</span>
    <span class="c1">// original infill image</span>
    <span class="c1">//</span>
    <span class="c1">// outputs</span>
    <span class="c1">//-------</span>
    <span class="c1">// masked &amp; thresholded infill activation</span>
    <span class="c1">//</span>
    <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">ChStatus</span><span class="o">&amp;</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ev_chstatus</span><span class="p">.</span><span class="n">Status</span><span class="p">(</span><span class="n">infill</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">plane</span><span class="p">());</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">short</span><span class="o">&gt;</span> <span class="n">st_v</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">as_vector</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">col</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">col</span><span class="o">&lt;</span><span class="n">infill</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">cols</span><span class="p">();</span> <span class="n">col</span><span class="o">++</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">col</span><span class="o">+</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">infill</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">min_x</span><span class="p">())</span><span class="o">&gt;=</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">st_v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">// bounds check</span>
      <span class="k">if</span><span class="p">(</span><span class="n">st_v</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="n">infill</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">min_x</span><span class="p">()]</span><span class="o">==</span><span class="mi">4</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">//if good ch skip</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">row</span><span class="o">&lt;</span><span class="n">infill</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">rows</span><span class="p">();</span> <span class="n">row</span><span class="o">++</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="n">infill</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">)</span><span class="o">&lt;</span><span class="n">score_thresh</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">//infill score threshold</span>
    <span class="n">masked_infill</span><span class="p">.</span><span class="n">set_pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span><span class="c1">//end of row</span>
    <span class="p">}</span><span class="c1">//end of col</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">addInfill</span><span class="p">(</span> <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">masked_infill</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">EventChStatus</span><span class="o">&amp;</span> <span class="n">ev_chstatus</span><span class="p">,</span>
                    <span class="k">const</span> <span class="kt">float</span> <span class="n">threshold</span><span class="p">,</span>
                    <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">img_fill_v</span><span class="p">){</span>
    <span class="c1">// adds infill activation to existing adc image</span>
    <span class="c1">// adc is set w.r.t. some charge threshold</span>
    <span class="c1">// inputs</span>
    <span class="c1">//-------</span>
    <span class="c1">// infill activation</span>
    <span class="c1">// original adc image</span>
    <span class="c1">//</span>
    <span class="c1">// outputs</span>
    <span class="c1">//---------</span>
    <span class="c1">// edited adc image</span>
    <span class="c1">//</span>

    <span class="c1">// int maxcol = img_fill_v.meta().cols();</span>
    <span class="c1">// int maxcol_plane = maxcol;</span>
    <span class="c1">// if ( img_fill_v.meta().plane()&lt;2 ) {</span>
    <span class="c1">//   maxcol_plane = img_fill_v.meta().col(2399)+1; // maxwire</span>
    <span class="c1">// }</span>
    <span class="c1">// else {</span>
    <span class="c1">//   maxcol_plane = img_fill_v.meta().col(3455)+1; // maxwire</span>
    <span class="c1">// }</span>
    <span class="c1">// maxcol = ( maxcol&gt;maxcol_plane) ? maxcol_plane : maxcol;</span>

    <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">ChStatus</span><span class="o">&amp;</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ev_chstatus</span><span class="p">.</span><span class="n">Status</span><span class="p">(</span><span class="n">masked_infill</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">plane</span><span class="p">());</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">short</span><span class="o">&gt;</span> <span class="n">st_v</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">as_vector</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">col</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">col</span><span class="o">&lt;</span><span class="n">masked_infill</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">cols</span><span class="p">();</span> <span class="n">col</span><span class="o">++</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">col</span><span class="o">+</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">masked_infill</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">min_x</span><span class="p">())</span><span class="o">&gt;=</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">st_v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">// bounds check</span>
      <span class="k">if</span><span class="p">(</span><span class="n">st_v</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="n">masked_infill</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">min_x</span><span class="p">()]</span><span class="o">==</span><span class="mi">4</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">//if good ch skip</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">row</span><span class="o">&lt;</span><span class="n">masked_infill</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">rows</span><span class="p">();</span> <span class="n">row</span><span class="o">++</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="n">masked_infill</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">//masked infill</span>
    <span class="n">img_fill_v</span><span class="p">.</span><span class="n">set_pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">threshold</span><span class="o">+</span><span class="mf">5.</span><span class="p">);</span> <span class="c1">//set adc to above threshold</span>
      <span class="p">}</span><span class="c1">//end of row</span>
    <span class="p">}</span><span class="c1">//end of col</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">labelInfillHits</span><span class="p">(</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;&amp;</span> <span class="n">masked_infill</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// store Infill above thresh information into hit2flow data</span>
    <span class="c1">// inputs</span>
    <span class="c1">// ------</span>
    <span class="c1">// masked_infill: assuming vector is (u,v,y)</span>
    <span class="c1">// ** we assume the above cover the same subimage region</span>
    <span class="c1">//</span>
    <span class="c1">// output</span>
    <span class="c1">// -------</span>
    <span class="c1">// updates m_plhit2flowdata[Y2U and Y2V] (if exists)</span>

    <span class="c1">// can be whole view or subimage</span>
    <span class="c1">// we loop over hits, and check if image set is applicable</span>

    <span class="kt">bool</span> <span class="n">filled</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">ranY2U</span><span class="p">,</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">ranY2V</span> <span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;*</span> <span class="n">phitdata_v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">Y2U</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">Y2V</span><span class="p">)</span> <span class="p">};</span>

    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">iflow</span><span class="o">=</span><span class="n">kY2U</span><span class="p">;</span> <span class="n">iflow</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kNumFlowDirs</span><span class="p">;</span> <span class="n">iflow</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">filled</span><span class="p">[</span><span class="n">iflow</span><span class="p">]</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;&amp;</span>  <span class="n">hitdata_v</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">phitdata_v</span><span class="p">[</span><span class="n">iflow</span><span class="p">]);</span>
      <span class="c1">// we check if hit is contained</span>
      <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">infill_src</span> <span class="o">=</span> <span class="n">masked_infill</span><span class="p">[</span> <span class="n">kSourcePlane</span><span class="p">[</span><span class="n">iflow</span><span class="p">]</span> <span class="p">];</span>
      <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">infill_tar</span> <span class="o">=</span> <span class="n">masked_infill</span><span class="p">[</span> <span class="n">kTargetPlane</span><span class="p">[</span><span class="n">iflow</span><span class="p">]</span> <span class="p">];</span>
      <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">ImageMeta</span><span class="o">&amp;</span> <span class="n">src_meta</span> <span class="o">=</span> <span class="n">infill_src</span><span class="p">.</span><span class="n">meta</span><span class="p">();</span>
      <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">ImageMeta</span><span class="o">&amp;</span> <span class="n">tar_meta</span> <span class="o">=</span> <span class="n">infill_tar</span><span class="p">.</span><span class="n">meta</span><span class="p">();</span>

      <span class="k">for</span> <span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">hitdata</span> <span class="p">:</span> <span class="n">hitdata_v</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">src_meta</span><span class="p">.</span><span class="n">min_x</span><span class="p">()</span><span class="o">&lt;=</span><span class="n">hitdata</span><span class="p">.</span><span class="n">srcwire</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">srcwire</span><span class="o">&lt;</span><span class="n">src_meta</span><span class="p">.</span><span class="n">max_x</span><span class="p">()</span>
         <span class="o">&amp;&amp;</span> <span class="n">src_meta</span><span class="p">.</span><span class="n">min_y</span><span class="p">()</span><span class="o">&lt;=</span><span class="n">hitdata</span><span class="p">.</span><span class="n">pixtick</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">pixtick</span><span class="o">&lt;</span><span class="n">src_meta</span><span class="p">.</span><span class="n">max_y</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// inside image</span>

      <span class="kt">int</span> <span class="n">col</span> <span class="o">=</span> <span class="n">src_meta</span><span class="p">.</span><span class="n">col</span><span class="p">(</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">srcwire</span> <span class="p">);</span>
      <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">src_meta</span><span class="p">.</span><span class="n">row</span><span class="p">(</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">pixtick</span> <span class="p">);</span>
      <span class="n">hitdata</span><span class="p">.</span><span class="n">src_infill</span> <span class="o">=</span> <span class="p">(</span><span class="n">infill_src</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
      <span class="c1">// check if target pix is inside image</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">tar_meta</span><span class="p">.</span><span class="n">min_x</span><span class="p">()</span><span class="o">&lt;=</span><span class="n">hitdata</span><span class="p">.</span><span class="n">targetwire</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">targetwire</span><span class="o">&lt;</span><span class="n">tar_meta</span><span class="p">.</span><span class="n">max_x</span><span class="p">()</span>
           <span class="o">&amp;&amp;</span> <span class="n">tar_meta</span><span class="p">.</span><span class="n">min_y</span><span class="p">()</span><span class="o">&lt;=</span><span class="n">hitdata</span><span class="p">.</span><span class="n">pixtick</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">pixtick</span><span class="o">&lt;</span><span class="n">tar_meta</span><span class="p">.</span><span class="n">max_y</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">colt</span><span class="o">=</span> <span class="n">tar_meta</span><span class="p">.</span><span class="n">col</span><span class="p">(</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">targetwire</span><span class="p">);</span>
        <span class="n">hitdata</span><span class="p">.</span><span class="n">tar_infill</span> <span class="o">=</span> <span class="p">(</span><span class="n">infill_tar</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">colt</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>
        <span class="c1">//not in crop</span>
        <span class="n">hitdata</span><span class="p">.</span><span class="n">tar_infill</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// =====================================================================</span>
  <span class="c1">// MCTRACK MATCH</span>
  <span class="c1">// --------------------</span>
  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">mctrack_match</span><span class="p">(</span> <span class="k">const</span> <span class="n">larlite</span><span class="o">::</span><span class="n">event_mctrack</span><span class="o">&amp;</span> <span class="n">evtrack</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;&amp;</span> <span class="n">img_v</span><span class="p">){</span>

    <span class="k">return</span> <span class="n">mctrack_match</span><span class="p">(</span> <span class="n">m_plhit2flowdata</span><span class="p">,</span> <span class="n">evtrack</span><span class="p">,</span> <span class="n">img_v</span><span class="p">,</span> <span class="n">m_psce</span><span class="p">,</span> <span class="n">m_ptsv</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">mctrack_match</span><span class="p">(</span><span class="n">PlaneHitFlowData_t</span><span class="o">&amp;</span> <span class="n">plhit2flowdata</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">larlite</span><span class="o">::</span><span class="n">event_mctrack</span><span class="o">&amp;</span> <span class="n">evtrack</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;&amp;</span> <span class="n">img_v</span><span class="p">,</span>
                       <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">SpaceChargeMicroBooNE</span><span class="o">*</span> <span class="n">psce</span><span class="p">,</span>
                       <span class="k">const</span> <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">TimeService</span><span class="o">*</span> <span class="n">ptsv</span><span class="p">){</span>

    <span class="c1">// This function updates internal std::vector&lt;HitFlowData_t&gt; to add mctruth.</span>
    <span class="c1">// It is intended to be run once per event,</span>
    <span class="c1">// when we have collected all hits in the whole image.</span>
    <span class="c1">// First all mctracks in the event are projected onto the whole Y image.</span>
    <span class="c1">// Then we match via hit source pixel and tick</span>

    <span class="c1">//space charge and time service; ideally initialized in algo constructor</span>
    <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">SpaceChargeMicroBooNE</span><span class="o">*</span> <span class="n">sce</span> <span class="o">=</span> <span class="n">psce</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">psce</span><span class="o">==</span><span class="nb">NULL</span> <span class="p">){</span>
      <span class="n">sce</span> <span class="o">=</span> <span class="k">new</span> <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">SpaceChargeMicroBooNE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// note on TimeService: if not initialized from root file via GetME(true)</span>
    <span class="c1">// needs trig_offset hack in tufts_larflow branch head</span>
    <span class="k">const</span> <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">TimeService</span><span class="o">*</span> <span class="n">tsv</span> <span class="o">=</span> <span class="n">ptsv</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">ptsv</span><span class="o">==</span><span class="nb">NULL</span><span class="p">){</span>
      <span class="n">tsv</span> <span class="o">=</span> <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">TimeService</span><span class="o">::</span><span class="n">GetME</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// blank track images: trackid, x, y, z, E, flag, dWall with Y meta</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;</span> <span class="n">trackimg_v</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
      <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span> <span class="n">trackimg</span><span class="p">(</span><span class="n">img_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">meta</span><span class="p">());</span>
      <span class="n">trackimg</span><span class="p">.</span><span class="n">paint</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">);</span>
      <span class="n">trackimg_v</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">trackimg</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">truthtrack</span> <span class="p">:</span> <span class="n">evtrack</span><span class="p">){</span>
      <span class="c1">//initialize internal vectors</span>
      <span class="kt">int</span> <span class="n">nstep</span> <span class="o">=</span> <span class="n">truthtrack</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">trackid</span><span class="p">;</span><span class="c1">//(nstep,0);</span>
      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">E</span><span class="p">;</span><span class="c1">//(nstep,0);</span>
      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&gt;</span> <span class="n">tyz</span><span class="p">;</span><span class="c1">//(nstep,std::vector&lt;double&gt;(3,0));</span>
      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">dWall</span><span class="p">;</span>

      <span class="n">_mctrack_to_tyz</span><span class="p">(</span><span class="n">truthtrack</span><span class="p">,</span><span class="n">tyz</span><span class="p">,</span><span class="n">trackid</span><span class="p">,</span><span class="n">E</span><span class="p">,</span><span class="n">dWall</span><span class="p">,</span><span class="n">sce</span><span class="p">,</span><span class="n">tsv</span><span class="p">);</span>
      <span class="n">_tyz_to_pixels</span><span class="p">(</span><span class="n">tyz</span><span class="p">,</span><span class="n">trackid</span><span class="p">,</span><span class="n">E</span><span class="p">,</span><span class="n">dWall</span><span class="p">,</span><span class="n">img_v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">trackimg_v</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;*</span> <span class="n">hit2flowdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">Y2U</span><span class="p">;</span> <span class="c1">// assign Y2U first</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;*</span> <span class="n">hit2flowdata2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">ranY2U</span> <span class="o">&amp;&amp;</span> <span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">ranY2V</span><span class="p">){</span>
      <span class="n">hit2flowdata2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">Y2V</span><span class="p">;</span> <span class="c1">// also assign Y2V</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">ranY2U</span> <span class="o">&amp;&amp;</span> <span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">ranY2V</span><span class="p">){</span>
      <span class="n">hit2flowdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">Y2V</span><span class="p">;</span> <span class="c1">//assign Y2V only</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">ranY2U</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">ranY2V</span><span class="p">){</span>
      <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;FlowContourMatch::mctrack_match -- no hits filled&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
      <span class="c1">//do nothing</span>
    <span class="p">}</span>
    <span class="c1">// now we loop over HitFlowData_t</span>
    <span class="c1">// note: this copies the same mctruth to Y2U and Y2V, b/c we don&#39;t know</span>
    <span class="c1">// at this point which one will be selected</span>
    <span class="c1">//</span>
    <span class="c1">// to check: are srcwire, pixtick in global (whole img) scope??</span>
    <span class="c1">// if not, I need the crop image meta</span>

    <span class="k">for</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">hit</span> <span class="p">:</span> <span class="o">*</span><span class="p">(</span><span class="n">hit2flowdata</span><span class="p">)){</span>
      <span class="n">hit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">hit</span><span class="p">.</span><span class="n">pixtick</span> <span class="o">&gt;=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">min_y</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">hit</span><span class="p">.</span><span class="n">pixtick</span> <span class="o">&lt;</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">max_y</span><span class="p">()</span>
     <span class="o">&amp;&amp;</span> <span class="n">hit</span><span class="p">.</span><span class="n">srcwire</span> <span class="o">&gt;=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">min_x</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">hit</span><span class="p">.</span><span class="n">srcwire</span> <span class="o">&lt;</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">max_x</span><span class="p">()</span> <span class="p">){</span>
    <span class="kt">int</span> <span class="n">col</span> <span class="o">=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">col</span><span class="p">(</span> <span class="n">hit</span><span class="p">.</span><span class="n">srcwire</span> <span class="p">);</span>
    <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">row</span><span class="p">(</span> <span class="n">hit</span><span class="p">.</span><span class="n">pixtick</span> <span class="p">);</span>

    <span class="n">hit</span><span class="p">.</span><span class="n">trackid</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">);</span>
    <span class="n">hit</span><span class="p">.</span><span class="n">truthflag</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">trackimg_v</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//nomatch is -1 in blank image</span>
    <span class="n">hit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">);</span>
    <span class="n">hit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">);</span>
    <span class="n">hit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">);</span>
    <span class="n">hit</span><span class="p">.</span><span class="n">dWall</span>      <span class="o">=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">);</span>
    <span class="c1">//std::cout &lt;&lt;&quot;dWall= &quot;&lt;&lt; hit.dWall &lt;&lt; std::endl;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">hit2flowdata2</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
      <span class="k">for</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">hit</span> <span class="p">:</span> <span class="o">*</span><span class="p">(</span><span class="n">hit2flowdata2</span><span class="p">)){</span>
    <span class="n">hit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">hit</span><span class="p">.</span><span class="n">pixtick</span> <span class="o">&gt;=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">min_y</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">hit</span><span class="p">.</span><span class="n">pixtick</span> <span class="o">&lt;</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">max_y</span><span class="p">()</span>
       <span class="o">&amp;&amp;</span> <span class="n">hit</span><span class="p">.</span><span class="n">srcwire</span> <span class="o">&gt;=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">min_x</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">hit</span><span class="p">.</span><span class="n">srcwire</span> <span class="o">&lt;</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">max_x</span><span class="p">()</span> <span class="p">){</span>
      <span class="kt">int</span> <span class="n">col</span> <span class="o">=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">col</span><span class="p">(</span> <span class="n">hit</span><span class="p">.</span><span class="n">srcwire</span> <span class="p">);</span>
      <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">row</span><span class="p">(</span> <span class="n">hit</span><span class="p">.</span><span class="n">pixtick</span> <span class="p">);</span>

      <span class="n">hit</span><span class="p">.</span><span class="n">trackid</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">);</span>
      <span class="n">hit</span><span class="p">.</span><span class="n">truthflag</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">trackimg_v</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">hit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">);</span>
      <span class="n">hit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">);</span>
      <span class="n">hit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">);</span>
      <span class="n">hit</span><span class="p">.</span><span class="n">dWall</span>      <span class="o">=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">);</span>
    <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">_mctrack_to_tyz</span><span class="p">(</span><span class="k">const</span> <span class="n">larlite</span><span class="o">::</span><span class="n">mctrack</span><span class="o">&amp;</span> <span class="n">truthtrack</span><span class="p">,</span>
                     <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&gt;&amp;</span> <span class="n">tyz</span><span class="p">,</span>
                     <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">trackid</span><span class="p">,</span>
                     <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span> <span class="n">E</span><span class="p">,</span>
                     <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&amp;</span> <span class="n">dWall</span><span class="p">,</span>
                     <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">SpaceChargeMicroBooNE</span><span class="o">*</span> <span class="n">sce</span><span class="p">,</span>
                     <span class="k">const</span> <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">TimeService</span><span class="o">*</span> <span class="n">tsv</span><span class="p">){</span>

    <span class="k">const</span> <span class="kt">float</span> <span class="n">cm_per_tick</span> <span class="o">=</span> <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">LArProperties</span><span class="o">::</span><span class="n">GetME</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">DriftVelocity</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">DetectorProperties</span><span class="o">::</span><span class="n">GetME</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SamplingRate</span><span class="p">()</span><span class="o">*</span><span class="mf">1.0e-3</span><span class="p">);</span>
    <span class="c1">// detector boundaries</span>
    <span class="k">const</span> <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">Geometry</span><span class="o">*</span> <span class="n">geo</span> <span class="o">=</span> <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">Geometry</span><span class="o">::</span><span class="n">GetME</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">xmin</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">DetHalfWidth</span><span class="p">()</span><span class="o">*</span><span class="mf">2.</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">ymin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">*</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">DetHalfHeight</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">DetHalfHeight</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">zmin</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">DetLength</span><span class="p">();</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">step</span><span class="o">&lt;</span><span class="n">truthtrack</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">step</span><span class="o">++</span><span class="p">){</span>
      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">pos</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="c1">//x,y,z</span>
      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">dr</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="c1">// x,y,z,t</span>
      <span class="n">dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">truthtrack</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">X</span><span class="p">()</span><span class="o">+</span><span class="n">truthtrack</span><span class="p">[</span><span class="n">step</span><span class="p">].</span><span class="n">X</span><span class="p">();</span>
      <span class="n">dr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">truthtrack</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">Y</span><span class="p">()</span><span class="o">+</span><span class="n">truthtrack</span><span class="p">[</span><span class="n">step</span><span class="p">].</span><span class="n">Y</span><span class="p">();</span>
      <span class="n">dr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">truthtrack</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">Z</span><span class="p">()</span><span class="o">+</span><span class="n">truthtrack</span><span class="p">[</span><span class="n">step</span><span class="p">].</span><span class="n">Z</span><span class="p">();</span>
      <span class="n">dr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">truthtrack</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">T</span><span class="p">()</span><span class="o">+</span><span class="n">truthtrack</span><span class="p">[</span><span class="n">step</span><span class="p">].</span><span class="n">T</span><span class="p">();</span>
      <span class="kt">float</span> <span class="n">dR</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">));</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="n">dr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">dR</span><span class="p">;</span>

      <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="p">(</span><span class="n">dR</span><span class="o">&gt;</span><span class="mf">0.15</span><span class="p">)</span> <span class="o">?</span> <span class="n">dR</span><span class="o">/</span><span class="mf">0.15</span><span class="o">+</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
      <span class="kt">float</span> <span class="n">dstep</span> <span class="o">=</span> <span class="n">dR</span><span class="o">/</span><span class="kt">float</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="kt">float</span> <span class="n">mindist</span> <span class="o">=</span> <span class="mf">1.0e4</span><span class="p">;</span>
    <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">truthtrack</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">X</span><span class="p">()</span><span class="o">+</span><span class="n">dstep</span><span class="o">*</span><span class="n">i</span><span class="o">*</span><span class="n">dr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">truthtrack</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">Y</span><span class="p">()</span><span class="o">+</span><span class="n">dstep</span><span class="o">*</span><span class="n">i</span><span class="o">*</span><span class="n">dr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">truthtrack</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">Z</span><span class="p">()</span><span class="o">+</span><span class="n">dstep</span><span class="o">*</span><span class="n">i</span><span class="o">*</span><span class="n">dr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="c1">// for time use linear approximation</span>
    <span class="kt">float</span> <span class="n">t</span> <span class="o">=</span> <span class="n">truthtrack</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">T</span><span class="p">()</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">dstep</span><span class="o">*::</span><span class="n">larutil</span><span class="o">::</span><span class="n">LArProperties</span><span class="o">::</span><span class="n">GetME</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">DriftVelocity</span><span class="p">()</span><span class="o">*</span><span class="mf">1.0e3</span><span class="p">);</span> <span class="c1">// cm * cm/usec * usec/ns</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">pos_offset</span> <span class="o">=</span> <span class="n">sce</span><span class="o">-&gt;</span><span class="n">GetPosOffsets</span><span class="p">(</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>
    <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">pos_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.7</span><span class="p">;</span>
    <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pos_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pos_offset</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="c1">//time tick</span>
    <span class="kt">float</span> <span class="n">tick</span> <span class="o">=</span> <span class="n">tsv</span><span class="o">-&gt;</span><span class="n">TPCG4Time2Tick</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">cm_per_tick</span><span class="p">;</span>
    <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tick</span> <span class="o">+</span> <span class="n">tsv</span><span class="o">-&gt;</span><span class="n">TriggerOffsetTPC</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">DetectorProperties</span><span class="o">::</span><span class="n">GetME</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SamplingRate</span><span class="p">()</span><span class="o">*</span><span class="mf">1.0e-3</span><span class="p">))</span><span class="o">*</span><span class="n">cm_per_tick</span><span class="p">;</span> <span class="c1">// x in cm</span>
    <span class="c1">// SCE shifted min dist to wall</span>
    <span class="c1">//if(std::abs(pos[0] - xmin)&lt; mindist) mindist = std::abs(pos[0] - xmin);</span>
    <span class="c1">//if(std::abs(pos[0] - xmax)&lt; mindist) mindist = std::abs(pos[0] - xmax);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span><span class="o">&lt;</span> <span class="n">mindist</span><span class="p">)</span> <span class="n">mindist</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ymax</span><span class="p">)</span><span class="o">&lt;</span> <span class="n">mindist</span><span class="p">)</span> <span class="n">mindist</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ymax</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">)</span><span class="o">&lt;</span> <span class="n">mindist</span><span class="p">)</span> <span class="n">mindist</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">zmax</span><span class="p">)</span><span class="o">&lt;</span> <span class="n">mindist</span><span class="p">)</span> <span class="n">mindist</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">zmax</span><span class="p">);</span>

    <span class="n">tyz</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
    <span class="n">dWall</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">mindist</span><span class="p">);</span>
    <span class="n">trackid</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">truthtrack</span><span class="p">.</span><span class="n">TrackID</span><span class="p">());</span><span class="c1">//this is the same for all steps in a track</span>
    <span class="n">E</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">truthtrack</span><span class="p">[</span><span class="n">step</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">E</span><span class="p">());</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">_tyz_to_pixels</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&gt;&amp;</span> <span class="n">tyz</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">trackid</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span> <span class="n">E</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&amp;</span> <span class="n">dWall</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">adc</span><span class="p">,</span>
                    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;&amp;</span> <span class="n">trackimg_v</span><span class="p">){</span>

    <span class="c1">// this function updates the mctrack images for each mctrack</span>
    <span class="c1">// if two tracks are crossing, the corresponding pixel will be filled by the track with higher E at that point</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">imgpath</span><span class="p">;</span>
    <span class="n">imgpath</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">tyz</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="nl">pos</span> <span class="p">:</span> <span class="n">tyz</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">crossing_imgcoords</span> <span class="o">=</span> <span class="n">getProjectedPixel</span><span class="p">(</span> <span class="n">pos</span><span class="p">,</span> <span class="n">adc</span><span class="p">.</span><span class="n">meta</span><span class="p">(),</span> <span class="mi">3</span> <span class="p">);</span>
      <span class="n">imgpath</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">crossing_imgcoords</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">istep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">thresh</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">;</span> <span class="c1">// adc threshold</span>
    <span class="c1">// note: pix are image row, col numbers</span>
    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="nl">pix</span> <span class="p">:</span> <span class="n">imgpath</span> <span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">pix</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">){</span><span class="n">istep</span><span class="o">++</span><span class="p">;</span> <span class="k">continue</span><span class="p">;}</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">b</span><span class="o">=</span><span class="n">pix</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span> <span class="n">b</span><span class="o">&lt;</span><span class="n">pix</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span> <span class="n">b</span><span class="o">++</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">b</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">||</span> <span class="n">b</span><span class="o">&gt;=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">cols</span><span class="p">())</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">//border case</span>
    <span class="kt">double</span> <span class="n">prevE</span> <span class="o">=</span> <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">prevE</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">prevE</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">istep</span><span class="p">)</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">//fill only highest E deposit</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">adc</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">)</span><span class="o">&lt;</span><span class="n">thresh</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">set_pixel</span><span class="p">(</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">,(</span><span class="kt">float</span><span class="p">)</span><span class="n">trackid</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">istep</span><span class="p">));</span><span class="c1">// trackid</span>
    <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">set_pixel</span><span class="p">(</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">,(</span><span class="kt">float</span><span class="p">)</span><span class="n">tyz</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">istep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span> <span class="c1">// x</span>
    <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">set_pixel</span><span class="p">(</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">,(</span><span class="kt">float</span><span class="p">)</span><span class="n">tyz</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">istep</span><span class="p">)[</span><span class="mi">1</span><span class="p">]);</span> <span class="c1">// y</span>
    <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">set_pixel</span><span class="p">(</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">,(</span><span class="kt">float</span><span class="p">)</span><span class="n">tyz</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">istep</span><span class="p">)[</span><span class="mi">2</span><span class="p">]);</span> <span class="c1">// z</span>
    <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">set_pixel</span><span class="p">(</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">,(</span><span class="kt">float</span><span class="p">)</span><span class="n">E</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">istep</span><span class="p">));</span> <span class="c1">// E</span>
    <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">==</span><span class="n">pix</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 1: on track, 2: on smear //+1 when filling hit</span>
    <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">set_pixel</span><span class="p">(</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">,(</span><span class="kt">float</span><span class="p">)</span><span class="n">flag</span><span class="p">);</span> <span class="c1">// flag</span>
    <span class="n">trackimg_v</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">set_pixel</span><span class="p">(</span><span class="n">pix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">,(</span><span class="kt">float</span><span class="p">)</span><span class="n">dWall</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">istep</span><span class="p">));</span> <span class="c1">//dWall</span>
      <span class="p">}</span>
      <span class="n">istep</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="c1">// copy of UBWireTool::getProjectedImagePixel</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">getProjectedPixel</span><span class="p">(</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&amp;</span> <span class="n">pos3d</span><span class="p">,</span>
                            <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">ImageMeta</span><span class="o">&amp;</span> <span class="n">meta</span><span class="p">,</span>
                            <span class="k">const</span> <span class="kt">int</span> <span class="n">nplanes</span><span class="p">,</span>
                            <span class="k">const</span> <span class="kt">float</span> <span class="n">fracpixborder</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">img_coords</span><span class="p">(</span> <span class="n">nplanes</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span>
    <span class="kt">float</span> <span class="n">row_border</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">fracpixborder</span><span class="p">)</span><span class="o">*</span><span class="n">meta</span><span class="p">.</span><span class="n">pixel_height</span><span class="p">();</span>
    <span class="kt">float</span> <span class="n">col_border</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">fracpixborder</span><span class="p">)</span><span class="o">*</span><span class="n">meta</span><span class="p">.</span><span class="n">pixel_width</span><span class="p">();</span>

    <span class="c1">// tick/row</span>
    <span class="kt">float</span> <span class="n">tick</span> <span class="o">=</span> <span class="n">pos3d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">LArProperties</span><span class="o">::</span><span class="n">GetME</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">DriftVelocity</span><span class="p">()</span><span class="o">*::</span><span class="n">larutil</span><span class="o">::</span><span class="n">DetectorProperties</span><span class="o">::</span><span class="n">GetME</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SamplingRate</span><span class="p">()</span><span class="o">*</span><span class="mf">1.0e-3</span><span class="p">)</span> <span class="o">+</span> <span class="mf">3200.0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">tick</span><span class="o">&lt;</span><span class="n">meta</span><span class="p">.</span><span class="n">min_y</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">tick</span><span class="o">&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">min_y</span><span class="p">()</span><span class="o">-</span><span class="n">row_border</span> <span class="p">)</span>
    <span class="c1">// below min_y-border, out of image</span>
    <span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">rows</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// note that tick axis and row indicies are in inverse order (same order in larcv2)</span>
      <span class="k">else</span>
    <span class="c1">// outside of image and border</span>
    <span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">tick</span><span class="o">&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">max_y</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">tick</span><span class="o">&lt;</span><span class="n">meta</span><span class="p">.</span><span class="n">max_y</span><span class="p">()</span><span class="o">+</span><span class="n">row_border</span> <span class="p">)</span>
    <span class="c1">// within upper border</span>
    <span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">else</span>
    <span class="c1">// outside of image and border</span>
    <span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// within the image</span>
      <span class="n">img_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">row</span><span class="p">(</span> <span class="n">tick</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Columns</span>
    <span class="n">Double_t</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">pos3d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos3d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pos3d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">};</span>
    <span class="c1">// there is a corner where the V plane wire number causes an error</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">pos3d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;-</span><span class="mf">117.0</span> <span class="o">&amp;&amp;</span> <span class="n">pos3d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;-</span><span class="mf">116.0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pos3d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">2.0</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">//std::cout &lt;&lt; __PRETTY_FUNCTION__ &lt;&lt; &quot;: v-plane corner hack (&quot; &lt;&lt; xyz[0] &lt;&lt; &quot;,&quot; &lt;&lt; xyz[1] &lt;&lt; &quot;,&quot; &lt;&lt; xyz[2] &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;</span>
      <span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">116.0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">p</span><span class="o">&lt;</span><span class="n">nplanes</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">float</span> <span class="n">wire</span> <span class="o">=</span> <span class="n">larutil</span><span class="o">::</span><span class="n">Geometry</span><span class="o">::</span><span class="n">GetME</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">WireCoordinate</span><span class="p">(</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">p</span> <span class="p">);</span>
      <span class="c1">// round wire</span>
      <span class="c1">//wire = std::roundf(wire);</span>

      <span class="c1">// get image coordinates</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">wire</span><span class="o">&lt;</span><span class="n">meta</span><span class="p">.</span><span class="n">min_x</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">wire</span><span class="o">&gt;</span><span class="n">meta</span><span class="p">.</span><span class="n">min_x</span><span class="p">()</span><span class="o">-</span><span class="n">col_border</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">//std::cout &lt;&lt; __PRETTY_FUNCTION__ &lt;&lt; &quot; plane=&quot; &lt;&lt; p &lt;&lt; &quot; wire=&quot; &lt;&lt; wire &lt;&lt; &quot;&lt;&quot; &lt;&lt; meta.min_x()-col_border &lt;&lt; std::endl;</span>
      <span class="c1">// within lower border</span>
      <span class="n">img_coords</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
      <span class="n">img_coords</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">wire</span><span class="o">&gt;=</span><span class="n">meta</span><span class="p">.</span><span class="n">max_x</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">wire</span><span class="o">&lt;</span><span class="n">meta</span><span class="p">.</span><span class="n">max_x</span><span class="p">()</span><span class="o">+</span><span class="n">col_border</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">//std::cout &lt;&lt; __PRETTY_FUNCTION__ &lt;&lt; &quot; plane=&quot; &lt;&lt; p &lt;&lt; &quot; wire=&quot; &lt;&lt; wire &lt;&lt; &quot;&gt;&quot; &lt;&lt; meta.max_x()+col_border &lt;&lt; std::endl;</span>
      <span class="c1">// within border</span>
      <span class="n">img_coords</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">cols</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
      <span class="c1">// outside border</span>
      <span class="n">img_coords</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
    <span class="c1">// inside image</span>
    <span class="n">img_coords</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">col</span><span class="p">(</span> <span class="n">wire</span> <span class="p">);</span>
    <span class="p">}</span><span class="c1">//end of plane loop</span>

    <span class="c1">// there is a corner where the V plane wire number causes an error</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">pos3d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;-</span><span class="mf">116.3</span> <span class="o">&amp;&amp;</span> <span class="n">pos3d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">2.0</span> <span class="o">&amp;&amp;</span> <span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">img_coords</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">img_coords</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// ----------------------------------</span>
  <span class="c1">// TRUTH MATCH WITH ANCESTOR IMAGES</span>
  <span class="c1">// ----------------------------------</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">label_mcid_w_ancestor_img</span><span class="p">(</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;&amp;</span> <span class="n">ancestor_v</span><span class="p">,</span>
                            <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;&amp;</span> <span class="n">adcimg_v</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;*</span> <span class="n">pflowdata</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="k">nullptr</span><span class="p">,</span> <span class="k">nullptr</span> <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">ranY2U</span> <span class="p">)</span>
      <span class="n">pflowdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">Y2U</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">ranY2V</span> <span class="p">)</span>
      <span class="n">pflowdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">Y2V</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">pflowdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pflowdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;[FlowContourMatch::mctrack_match_w_ancestor_img] No hit information filled yet&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">nlabeled</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">iflow</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">iflow</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span> <span class="n">iflow</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">pflowdata</span><span class="p">[</span><span class="n">iflow</span><span class="p">]</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;&amp;</span> <span class="n">flowdata</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">pflowdata</span><span class="p">[</span><span class="n">iflow</span><span class="p">]);</span>

      <span class="c1">// ------------------------------------------------</span>
      <span class="c1">// debug</span>
      <span class="c1">// char hname[100];</span>
      <span class="c1">// sprintf( hname, &quot;ancestorlabel_flow%d&quot;, iflow );</span>
      <span class="c1">// TH2D hancestor = larcv::as_th2d( adcimg_v[2], hname );</span>
      <span class="c1">// hancestor.Reset();</span>
      <span class="c1">// for ( size_t r=0; r&lt;ancestor_v[2].meta().rows(); r++ ) {</span>
      <span class="c1">//    for ( size_t c=0; c&lt;ancestor_v[2].meta().cols(); c++ ) {</span>
      <span class="c1">//      if ( ancestor_v[2].pixel(r,c)&gt;=0 )</span>
      <span class="c1">//        hancestor.SetBinContent( c+1, r+1, 5 );</span>
      <span class="c1">//    }</span>
      <span class="c1">// }</span>
      <span class="c1">// ------------------------------------------------</span>

      <span class="kt">int</span> <span class="n">maxcol</span> <span class="o">=</span> <span class="n">ancestor_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">cols</span><span class="p">();</span>
      <span class="kt">int</span> <span class="n">maxrow</span> <span class="o">=</span> <span class="n">ancestor_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">rows</span><span class="p">();</span>

      <span class="k">for</span> <span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">hit</span> <span class="p">:</span> <span class="n">flowdata</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">hit</span><span class="p">.</span><span class="n">srcwire</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">||</span> <span class="n">hit</span><span class="p">.</span><span class="n">pixtick</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">col</span> <span class="o">=</span> <span class="n">ancestor_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">col</span><span class="p">(</span> <span class="n">hit</span><span class="p">.</span><span class="n">srcwire</span> <span class="p">);</span>
    <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">ancestor_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">row</span><span class="p">(</span> <span class="n">hit</span><span class="p">.</span><span class="n">pixtick</span> <span class="p">);</span>

    <span class="c1">// look in a neighborhood</span>
    <span class="kt">float</span> <span class="n">maxadc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">mcid_at_max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">dc</span><span class="o">=-</span><span class="mi">3</span><span class="p">;</span> <span class="n">dc</span><span class="o">&lt;=</span><span class="mi">3</span><span class="p">;</span> <span class="n">dc</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="o">+</span><span class="n">dc</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">c</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">||</span> <span class="n">c</span><span class="o">&gt;=</span><span class="n">maxcol</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">dr</span><span class="o">=-</span><span class="mi">10</span><span class="p">;</span> <span class="n">dr</span><span class="o">&lt;=</span><span class="mi">10</span><span class="p">;</span> <span class="n">dr</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">r</span><span class="o">=</span><span class="n">row</span><span class="o">+</span><span class="n">dr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">r</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">||</span> <span class="n">r</span><span class="o">&gt;=</span><span class="n">maxrow</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">adc</span> <span class="o">=</span> <span class="n">adcimg_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">mcid</span>  <span class="o">=</span> <span class="n">ancestor_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">adc</span><span class="o">&gt;</span><span class="n">maxadc</span> <span class="o">&amp;&amp;</span> <span class="n">mcid</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
          <span class="n">maxadc</span> <span class="o">=</span> <span class="n">adc</span><span class="p">;</span>
          <span class="n">mcid_at_max</span> <span class="o">=</span> <span class="n">mcid</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">hit</span><span class="p">.</span><span class="n">trackid</span> <span class="o">=</span> <span class="n">mcid_at_max</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">mcid_at_max</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">//hancestor.SetBinContent( col+1, row+1, 10 );</span>
      <span class="n">nlabeled</span><span class="p">[</span><span class="n">iflow</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="c1">//hancestor.SetBinContent( col+1, row+1, -5 );</span>
    <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;[FlowContourMatch::label_mcid_w_ancestor_img] &quot;</span>
        <span class="o">&lt;&lt;</span> <span class="s">&quot;Flow path &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">iflow</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; labeled hits=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">nlabeled</span><span class="p">[</span><span class="n">iflow</span><span class="p">]</span>
        <span class="o">&lt;&lt;</span> <span class="s">&quot; of &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flowdata</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; all hits&quot;</span>
        <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

      <span class="c1">// ---------------------------------</span>
      <span class="c1">// debug</span>
      <span class="c1">// gStyle-&gt;SetOptStat(0);</span>
      <span class="c1">// TCanvas c(&quot;c&quot;,&quot;c&quot;,800,600);</span>
      <span class="c1">// hancestor.Draw(&quot;colz&quot;);</span>
      <span class="c1">// std::string canvname = std::string(hname)+&quot;.png&quot;;</span>
      <span class="c1">// c.SaveAs( canvname.c_str() );</span>
      <span class="c1">// std::cout &lt;&lt; &quot;[FlowContourMatch::label_mcid_w_ancestor_img] [DEBUG] save &quot; &lt;&lt; hname &lt;&lt; std::endl;</span>
      <span class="c1">// ---------------------------------</span>

    <span class="p">}</span>

  <span class="p">}</span>

  <span class="c1">// =====================================================================</span>
  <span class="c1">// INTERNAL FUNCTIONS</span>
  <span class="c1">// --------------------</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">_fill_consistency3d</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;&amp;</span> <span class="n">Y2U</span><span class="p">,</span>
                         <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;&amp;</span> <span class="n">Y2V</span><span class="p">,</span>
                         <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">consistency3d</span><span class="p">,</span>
                         <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&amp;</span> <span class="n">dy</span><span class="p">,</span>
                         <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&amp;</span> <span class="n">dz</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float</span> <span class="n">ddy</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">ddz</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">Y2U</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">Y2V</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">//nothing was filled</span>

    <span class="c1">// if here, at least flow was filled. we allocate consistency vectors</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">Y2U</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">consistency3d</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="n">Y2U</span><span class="p">.</span><span class="n">size</span><span class="p">())</span>
     <span class="o">||</span> <span class="p">(</span><span class="n">Y2V</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">consistency3d</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="n">Y2V</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">consistency3d</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span> <span class="n">Y2U</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">dy</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span> <span class="n">Y2U</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span>
      <span class="n">dz</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span> <span class="n">Y2U</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//first fill 3D coord</span>
    <span class="k">if</span><span class="p">(</span><span class="n">Y2U</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">Y2U</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="n">Y2U</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">_calc_coord3d</span><span class="p">(</span><span class="n">Y2U</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">Y2U</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">,</span><span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">kY2U</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">Y2V</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">Y2V</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="n">Y2V</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">_calc_coord3d</span><span class="p">(</span><span class="n">Y2V</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">Y2V</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">,</span><span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">kY2V</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">//if both flow information is provided, we can run consistency measures</span>
    <span class="k">if</span><span class="p">(</span><span class="n">Y2U</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">Y2V</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
      <span class="c1">//both are same size (by construction)</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">Y2U</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="n">_calc_dist3d</span><span class="p">(</span><span class="n">Y2U</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">,</span><span class="n">Y2V</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">X</span><span class="p">,</span><span class="n">ddy</span><span class="p">,</span><span class="n">ddz</span><span class="p">);</span>
    <span class="n">dy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddy</span><span class="p">;</span>
    <span class="n">dz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddz</span><span class="p">;</span>
    <span class="n">consistency3d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_calc_consistency3d</span><span class="p">(</span><span class="n">ddy</span><span class="p">,</span><span class="n">ddz</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="c1">//end of both</span>
  <span class="p">}</span>


  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">_calc_coord3d</span><span class="p">(</span><span class="n">HitFlowData_t</span><span class="o">&amp;</span> <span class="n">hit_y2u</span><span class="p">,</span>
                       <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&amp;</span> <span class="n">X</span><span class="p">,</span>
                       <span class="n">FlowDirection_t</span> <span class="n">flowdir</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">hit_y2u</span><span class="p">.</span><span class="n">srcwire</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">||</span> <span class="n">hit_y2u</span><span class="p">.</span><span class="n">srcwire</span><span class="o">&gt;=</span><span class="mi">3456</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// this hit has no flow-match data</span>
      <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// for debug</span>
    <span class="c1">//std::cout &lt;&lt; __PRETTY_FUNCTION__ &lt;&lt; &quot;src wire=&quot; &lt;&lt; hit_y2u.srcwire &lt;&lt; &quot; tar(u)=&quot; &lt;&lt; hit_y2u.targetwire &lt;&lt; std::endl;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">hit_y2u</span><span class="p">.</span><span class="n">targetwire</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">||</span> <span class="n">hit_y2u</span><span class="p">.</span><span class="n">targetwire</span><span class="o">&gt;=</span><span class="mi">2400</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// flow is out of the plane (track how this happend).</span>
      <span class="c1">// for now, we do not have a vaule</span>
      <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// larlite geometry tool</span>
    <span class="k">const</span> <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">Geometry</span><span class="o">*</span> <span class="n">geo</span> <span class="o">=</span> <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">Geometry</span><span class="o">::</span><span class="n">GetME</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">cm_per_tick</span>      <span class="o">=</span> <span class="o">::</span><span class="n">larutil</span><span class="o">::</span><span class="n">LArProperties</span><span class="o">::</span><span class="n">GetME</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">DriftVelocity</span><span class="p">()</span><span class="o">*</span><span class="mf">0.5</span><span class="p">;</span> <span class="c1">// cm/usec * usec/tick</span>
    <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hit_y2u</span><span class="p">.</span><span class="n">pixtick</span><span class="o">-</span><span class="mf">3200.0</span><span class="p">)</span><span class="o">*</span><span class="n">cm_per_tick</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">y</span><span class="o">=-</span><span class="mf">1.</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">z</span><span class="o">=-</span><span class="mf">1.</span><span class="p">;</span>
    <span class="c1">//Get intersection</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="n">flowdir</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">kY2U</span><span class="p">:</span>
      <span class="n">geo</span><span class="o">-&gt;</span><span class="n">IntersectionPoint</span><span class="p">(</span> <span class="n">hit_y2u</span><span class="p">.</span><span class="n">srcwire</span><span class="p">,</span> <span class="n">hit_y2u</span><span class="p">.</span><span class="n">targetwire</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">kY2V</span><span class="p">:</span>
      <span class="n">geo</span><span class="o">-&gt;</span><span class="n">IntersectionPoint</span><span class="p">(</span> <span class="n">hit_y2u</span><span class="p">.</span><span class="n">srcwire</span><span class="p">,</span> <span class="n">hit_y2u</span><span class="p">.</span><span class="n">targetwire</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;FlowContourMatch::calc_coord3d: invalid FlowDirection_t option&quot;</span><span class="p">);</span> <span class="c1">// shouldnt be possible</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
    <span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">;</span>

  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">_calc_dist3d</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&amp;</span> <span class="n">X0</span><span class="p">,</span>
                      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&amp;</span> <span class="n">X1</span><span class="p">,</span>
                      <span class="kt">float</span><span class="o">&amp;</span> <span class="n">dy</span><span class="p">,</span>
                      <span class="kt">float</span><span class="o">&amp;</span> <span class="n">dz</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">X0</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="o">||</span>  <span class="n">X1</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="o">||</span> <span class="n">X0</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="n">X1</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">// one of the 3D positions was not properly initialized: should not happen</span>
      <span class="n">dy</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">dz</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">any_of</span><span class="p">(</span><span class="n">X0</span><span class="p">.</span><span class="n">cbegin</span><span class="p">(),</span> <span class="n">X0</span><span class="p">.</span><span class="n">cend</span><span class="p">(),</span> <span class="p">[](</span><span class="kt">int</span> <span class="n">i</span><span class="p">){</span> <span class="k">return</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">})</span>
     <span class="o">||</span> <span class="n">std</span><span class="o">::</span><span class="n">any_of</span><span class="p">(</span><span class="n">X1</span><span class="p">.</span><span class="n">cbegin</span><span class="p">(),</span> <span class="n">X1</span><span class="p">.</span><span class="n">cend</span><span class="p">(),</span> <span class="p">[](</span><span class="kt">int</span> <span class="n">i</span><span class="p">){</span> <span class="k">return</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">}))</span> <span class="p">{</span>
      <span class="c1">// one of the flows is out of the plane (track how this happend).</span>
      <span class="c1">// for now, we do not have a vaule</span>
      <span class="n">dy</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">dy</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="n">dy</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">X0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">));</span>
    <span class="n">dz</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">X0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">2</span><span class="p">));</span>

  <span class="p">}</span>

  <span class="kt">int</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">_calc_consistency3d</span><span class="p">(</span><span class="kt">float</span><span class="o">&amp;</span> <span class="n">dy</span><span class="p">,</span>
                        <span class="kt">float</span><span class="o">&amp;</span> <span class="n">dz</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">dy</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">||</span> <span class="n">dz</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span>
       <span class="k">return</span> <span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kNoValue</span><span class="p">;</span> <span class="c1">// no</span>

    <span class="kt">float</span> <span class="n">dR</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span> <span class="o">+</span> <span class="n">dz</span><span class="o">*</span><span class="n">dz</span><span class="p">);</span>
    <span class="c1">//dR should be in cm?</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dR</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">return</span> <span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kIn5mm</span><span class="p">;</span>  <span class="c1">// kIn5mm</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dR</span><span class="o">&lt;</span><span class="mf">1.0</span><span class="p">)</span> <span class="k">return</span> <span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kIn10mm</span><span class="p">;</span> <span class="c1">// kIn10mm</span>
    <span class="k">if</span><span class="p">(</span><span class="n">dR</span><span class="o">&lt;</span><span class="mf">5.0</span><span class="p">)</span> <span class="k">return</span> <span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kIn50mm</span><span class="p">;</span> <span class="c1">// kIn50mm</span>
    <span class="k">return</span> <span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kOut50mm</span><span class="p">;</span>           <span class="c1">// kOut50mm</span>

  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">_match</span><span class="p">(</span> <span class="n">FlowDirection_t</span> <span class="n">flowdir</span><span class="p">,</span>
                 <span class="k">const</span> <span class="n">ublarcvapp</span><span class="o">::</span><span class="n">ContourClusterAlgo</span><span class="o">&amp;</span> <span class="n">contour_data</span><span class="p">,</span>
                 <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">src_adc</span><span class="p">,</span>
                 <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">tar_adc</span><span class="p">,</span>
                 <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">flow_img</span><span class="p">,</span>
                 <span class="k">const</span> <span class="n">larlite</span><span class="o">::</span><span class="n">event_hit</span><span class="o">&amp;</span> <span class="n">hit_v</span><span class="p">,</span>
                 <span class="k">const</span> <span class="kt">float</span> <span class="n">threshold</span> <span class="p">)</span> <span class="p">{</span>

    <span class="c1">// produces 3D hits from from one flow image</span>
    <span class="kt">int</span> <span class="n">src_planeid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">tar_planeid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span> <span class="n">flowdir</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">kY2U</span><span class="p">:</span>
      <span class="n">src_planeid</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="n">tar_planeid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">kY2V</span><span class="p">:</span>
      <span class="n">src_planeid</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="n">tar_planeid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;FlowContourMatch::match: invalid FlowDirection_t option&quot;</span><span class="p">);</span> <span class="c1">// shouldnt be possible</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// we clear the 2d data, but keep the hit data (which we will update with _make3Dhits)</span>
    <span class="n">clear</span><span class="p">(</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">flowdir</span> <span class="p">);</span>

    <span class="c1">// first we create match data within the image</span>
    <span class="n">_createMatchData</span><span class="p">(</span> <span class="n">contour_data</span><span class="p">,</span> <span class="n">flow_img</span><span class="p">,</span> <span class="n">src_adc</span><span class="p">,</span> <span class="n">tar_adc</span><span class="p">,</span> <span class="n">flowdir</span> <span class="p">);</span>

    <span class="c1">// use the match data to score contour-contour matching</span>
    <span class="n">_scoreMatches</span><span class="p">(</span> <span class="n">contour_data</span><span class="p">,</span> <span class="n">src_planeid</span><span class="p">,</span> <span class="n">tar_planeid</span><span class="p">,</span> <span class="n">flowdir</span> <span class="p">);</span>

    <span class="c1">// use score matrix to define matches</span>
    <span class="n">_greedyMatch</span><span class="p">(</span><span class="n">flowdir</span><span class="p">);</span>

    <span class="c1">// make 3D hits and update hit2flowdata vector</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">flowdir</span><span class="o">==</span><span class="n">kY2U</span> <span class="p">)</span>
      <span class="n">_make3Dhits</span><span class="p">(</span> <span class="n">hit_v</span><span class="p">,</span> <span class="n">src_adc</span><span class="p">,</span> <span class="n">tar_adc</span><span class="p">,</span> <span class="n">src_planeid</span><span class="p">,</span> <span class="n">tar_planeid</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">Y2U</span><span class="p">,</span> <span class="n">flowdir</span> <span class="p">);</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span> <span class="n">flowdir</span><span class="o">==</span><span class="n">kY2V</span> <span class="p">)</span>
      <span class="n">_make3Dhits</span><span class="p">(</span> <span class="n">hit_v</span><span class="p">,</span> <span class="n">src_adc</span><span class="p">,</span> <span class="n">tar_adc</span><span class="p">,</span> <span class="n">src_planeid</span><span class="p">,</span> <span class="n">tar_planeid</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">Y2V</span><span class="p">,</span> <span class="n">flowdir</span> <span class="p">);</span>
    <span class="k">else</span>
      <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;should never get here&quot;</span><span class="p">);</span>

  <span class="p">}</span>


  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">makeHitsFromWholeImagePixels</span><span class="p">(</span> <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">src_adc</span><span class="p">,</span> <span class="n">larlite</span><span class="o">::</span><span class="n">event_hit</span><span class="o">&amp;</span> <span class="n">evhit_v</span><span class="p">,</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">threshold</span> <span class="p">)</span> <span class="p">{</span>

    <span class="c1">// instead of hits, which can be too sparsely defined,</span>
    <span class="c1">// we can try to match pixels (or maybe eventually groups of pixels).</span>
    <span class="c1">// to use same machinery, we turn pixels into hits</span>
    <span class="c1">//</span>
    <span class="c1">// inputs</span>
    <span class="c1">// ------</span>
    <span class="c1">// src_adc: source ADC image</span>
    <span class="c1">// threshold: ADC threshold</span>
    <span class="c1">//</span>
    <span class="c1">// outputs</span>
    <span class="c1">// -------</span>
    <span class="c1">// evhit_v (by address): vector of hits created from above threshold pixels</span>

    <span class="n">evhit_v</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">evhit_v</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">maxcol</span> <span class="o">=</span> <span class="n">src_adc</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">cols</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">maxcol_plane</span> <span class="o">=</span> <span class="n">maxcol</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">src_adc</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">plane</span><span class="p">()</span><span class="o">&lt;</span><span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">maxcol_plane</span> <span class="o">=</span> <span class="n">src_adc</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">col</span><span class="p">(</span><span class="mi">2399</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// maxwire</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">maxcol_plane</span> <span class="o">=</span> <span class="n">src_adc</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">col</span><span class="p">(</span><span class="mi">3455</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// maxwire</span>
    <span class="p">}</span>
    <span class="n">maxcol</span> <span class="o">=</span> <span class="p">(</span> <span class="n">maxcol</span><span class="o">&gt;</span><span class="n">maxcol_plane</span><span class="p">)</span> <span class="o">?</span> <span class="nl">maxcol_plane</span> <span class="p">:</span> <span class="n">maxcol</span><span class="p">;</span>

    <span class="c1">// we loop over all source pixels and make &quot;hits&quot; for all pixels above threshold</span>
    <span class="kt">int</span> <span class="n">ihit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irow</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">irow</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">src_adc</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">rows</span><span class="p">();</span> <span class="n">irow</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">float</span> <span class="n">hit_tick</span> <span class="o">=</span> <span class="n">src_adc</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">pos_y</span><span class="p">(</span> <span class="n">irow</span> <span class="p">)</span><span class="o">-</span><span class="mf">2400.0</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">icol</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">icol</span><span class="o">&lt;</span><span class="n">maxcol</span><span class="p">;</span> <span class="n">icol</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float</span> <span class="n">pixval</span> <span class="o">=</span> <span class="n">src_adc</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span> <span class="n">irow</span><span class="p">,</span> <span class="n">icol</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pixval</span><span class="o">&lt;</span><span class="n">threshold</span> <span class="p">)</span>
      <span class="k">continue</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">wire</span> <span class="o">=</span> <span class="n">src_adc</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">pos_x</span><span class="p">(</span> <span class="n">icol</span> <span class="p">);</span>

    <span class="c1">// make fake hit from pixel</span>

    <span class="n">larlite</span><span class="o">::</span><span class="n">hit</span> <span class="n">h</span><span class="p">;</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_rms</span><span class="p">(</span> <span class="mf">1.0</span> <span class="p">);</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_time_range</span><span class="p">(</span> <span class="n">hit_tick</span><span class="p">,</span> <span class="n">hit_tick</span> <span class="p">);</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_time_peak</span><span class="p">(</span> <span class="n">hit_tick</span><span class="p">,</span> <span class="mf">1.0</span> <span class="p">);</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_time_rms</span><span class="p">(</span> <span class="mf">1.0</span> <span class="p">);</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_amplitude</span><span class="p">(</span> <span class="n">pixval</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">pixval</span><span class="p">)</span> <span class="p">);</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_integral</span><span class="p">(</span> <span class="n">pixval</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">pixval</span><span class="p">)</span> <span class="p">);</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_sumq</span><span class="p">(</span> <span class="n">pixval</span> <span class="p">);</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_multiplicity</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_local_index</span><span class="p">(</span> <span class="n">ihit</span> <span class="p">);</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_goodness</span><span class="p">(</span> <span class="mf">1.0</span> <span class="p">);</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_ndf</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>

    <span class="n">larlite</span><span class="o">::</span><span class="n">geo</span><span class="o">::</span><span class="n">WireID</span> <span class="n">wireid</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">src_adc</span><span class="p">.</span><span class="n">meta</span><span class="p">().</span><span class="n">plane</span><span class="p">(),</span> <span class="n">wire</span> <span class="p">);</span>
    <span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">larutil</span><span class="o">::</span><span class="n">Geometry</span><span class="o">::</span><span class="n">GetME</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">PlaneWireToChannel</span><span class="p">(</span> <span class="n">wireid</span><span class="p">.</span><span class="n">Plane</span><span class="p">,</span> <span class="n">wireid</span><span class="p">.</span><span class="n">Wire</span> <span class="p">);</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_channel</span><span class="p">(</span> <span class="n">ch</span> <span class="p">);</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_view</span><span class="p">(</span> <span class="p">(</span><span class="n">larlite</span><span class="o">::</span><span class="n">geo</span><span class="o">::</span><span class="n">View_t</span><span class="p">)</span><span class="n">wireid</span><span class="p">.</span><span class="n">Plane</span> <span class="p">);</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_wire</span><span class="p">(</span> <span class="n">wireid</span> <span class="p">);</span>
    <span class="n">h</span><span class="p">.</span><span class="n">set_signal_type</span><span class="p">(</span> <span class="n">larutil</span><span class="o">::</span><span class="n">Geometry</span><span class="o">::</span><span class="n">GetME</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SignalType</span><span class="p">(</span> <span class="n">ch</span> <span class="p">)</span> <span class="p">);</span>
    <span class="n">evhit_v</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="p">);</span>

    <span class="n">ihit</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="c1">// ==================================================================================</span>
  <span class="c1">// Algorithm (internal) Methods</span>
  <span class="c1">// -----------------------------</span>


  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">_scoreMatches</span><span class="p">(</span> <span class="k">const</span> <span class="n">ublarcvapp</span><span class="o">::</span><span class="n">ContourClusterAlgo</span><span class="o">&amp;</span> <span class="n">contour_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_planeid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tar_planeid</span><span class="p">,</span> <span class="k">const</span> <span class="n">FlowDirection_t</span> <span class="n">kflowdir</span> <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// takes src-target contour pairs and starts to calculate scores</span>
    <span class="c1">// scores are based on what fraction of pixels get matched from source to the target contour</span>
    <span class="c1">//</span>
    <span class="c1">// results use m_flowdata information</span>
    <span class="c1">//</span>
    <span class="c1">// things we fill</span>
    <span class="c1">// --------------</span>
    <span class="c1">// m_score_matrix: (src,target) contour index are the pos. in the array/matrix. value is score</span>
    <span class="c1">//</span>

    <span class="n">m_src_ncontours</span> <span class="o">=</span> <span class="n">contour_data</span><span class="p">.</span><span class="n">m_plane_atomics_v</span><span class="p">[</span><span class="n">src_planeid</span><span class="p">].</span><span class="n">size</span><span class="p">();</span>
    <span class="n">m_tar_ncontours</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">kflowdir</span><span class="p">]</span> <span class="o">=</span> <span class="n">contour_data</span><span class="p">.</span><span class="n">m_plane_atomics_v</span><span class="p">[</span><span class="n">tar_planeid</span><span class="p">].</span><span class="n">size</span><span class="p">();</span>
    <span class="c1">// std::cout &lt;&lt; __PRETTY_FUNCTION__ &lt;&lt; std::endl;</span>
    <span class="c1">// std::cout &lt;&lt; &quot;scr ncontours: &quot; &lt;&lt; m_src_ncontours &lt;&lt; std::endl;</span>
    <span class="c1">// std::cout &lt;&lt; &quot;tar ncontours: &quot; &lt;&lt; m_tar_ncontours &lt;&lt; std::endl;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">!=</span><span class="nb">NULL</span> <span class="p">)</span>
      <span class="k">delete</span> <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">];</span>

    <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="n">m_src_ncontours</span><span class="o">*</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]];</span> <span class="c1">// should probably its own class</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">m_score_matrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="o">*</span><span class="n">m_src_ncontours</span><span class="o">*</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">flowdata</span> <span class="p">:</span> <span class="n">m_flowdata</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kt">float</span> <span class="n">score</span> <span class="o">=</span> <span class="n">_scoreMatch</span><span class="p">(</span> <span class="n">flowdata</span> <span class="p">);</span>
      <span class="n">flowdata</span><span class="p">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="p">;</span>
      <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">][</span> <span class="n">flowdata</span><span class="p">.</span><span class="n">src_ctr_id</span><span class="o">*</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="o">+</span> <span class="n">flowdata</span><span class="p">.</span><span class="n">tar_ctr_id</span> <span class="p">]</span> <span class="o">=</span> <span class="n">score</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// normalize it</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">is</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">is</span><span class="o">&lt;</span><span class="n">m_src_ncontours</span><span class="p">;</span> <span class="n">is</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">float</span> <span class="n">norm_s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">it</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">it</span><span class="o">&lt;</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">];</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">norm_s</span> <span class="o">+=</span> <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">][</span> <span class="n">is</span><span class="o">*</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="o">+</span> <span class="n">it</span> <span class="p">];</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">norm_s</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">it</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">it</span><span class="o">&lt;</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">];</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">][</span> <span class="n">is</span><span class="o">*</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="o">+</span> <span class="n">it</span> <span class="p">]</span> <span class="o">/=</span> <span class="n">norm_s</span><span class="p">;</span>
    <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">}</span>

<span class="kt">float</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">_scoreMatch</span><span class="p">(</span> <span class="k">const</span> <span class="n">FlowMatchData_t</span><span class="o">&amp;</span> <span class="n">matchdata</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kt">float</span> <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nscores</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="nl">flow</span> <span class="p">:</span> <span class="n">matchdata</span><span class="p">.</span><span class="n">matchingflow_v</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">score</span> <span class="o">+=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">flow</span><span class="p">.</span><span class="n">pred_miss</span><span class="p">;</span>
      <span class="n">nscores</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">score</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">_greedyMatch</span><span class="p">(</span><span class="k">const</span> <span class="n">FlowDirection_t</span> <span class="n">kflowdir</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// goal is to assign a cluster on the</span>
    <span class="c1">// source plane purely to one on the target</span>
    <span class="c1">//</span>
    <span class="c1">// this function modifies m_score_matrix[kflowdir]</span>
    <span class="c1">//</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">is</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">is</span><span class="o">&lt;</span><span class="n">m_src_ncontours</span><span class="p">;</span> <span class="n">is</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">float</span> <span class="n">max_s</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
      <span class="kt">int</span>   <span class="n">idx</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">it</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">it</span><span class="o">&lt;</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">];</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float</span> <span class="n">score</span> <span class="o">=</span> <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">][</span> <span class="n">is</span><span class="o">*</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="o">+</span> <span class="n">it</span> <span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">score</span><span class="o">&gt;</span><span class="n">max_s</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">max_s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">idx</span> <span class="o">=</span> <span class="n">it</span><span class="p">;</span>
    <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">max_s</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">it</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">it</span><span class="o">&lt;</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">];</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">it</span><span class="o">!=</span><span class="n">idx</span> <span class="p">)</span>
        <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">][</span> <span class="n">is</span><span class="o">*</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="o">+</span> <span class="n">it</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">][</span> <span class="n">is</span><span class="o">*</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="o">+</span> <span class="n">it</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">dumpMatchData</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">__PRETTY_FUNCTION__</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;===Match Data. Direction &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; =======&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">flowdata</span> <span class="p">:</span> <span class="n">m_flowdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
    <span class="c1">//std::cout &lt;&lt; &quot;[CONTOURS: src(&quot; &lt;&lt; it.first[0] &lt;&lt; &quot;) -&gt; tar(&quot; &lt;&lt; it.first[1] &lt;&lt; &quot;)]&quot; &lt;&lt; std::endl;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;[CONTOURS: src(&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flowdata</span><span class="p">.</span><span class="n">src_ctr_id</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;) -&gt; tar(&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flowdata</span><span class="p">.</span><span class="n">tar_ctr_id</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;)]&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  Flow entries &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flowdata</span><span class="p">.</span><span class="n">matchingflow_v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="nl">flow</span> <span class="p">:</span> <span class="n">flowdata</span><span class="p">.</span><span class="n">matchingflow_v</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;    &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flow</span><span class="p">.</span><span class="n">row</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flow</span><span class="p">.</span><span class="n">src_wire</span>
            <span class="o">&lt;&lt;</span> <span class="s">&quot; -&gt; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flow</span><span class="p">.</span><span class="n">tar_wire</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  err=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">flow</span><span class="p">.</span><span class="n">pred_miss</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">TH2D</span><span class="o">&amp;</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">plotScoreMatrix</span><span class="p">(</span><span class="k">const</span> <span class="n">FlowDirection_t</span> <span class="n">kflowdir</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">m_plot_scorematrix</span><span class="o">!=</span><span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">delete</span> <span class="n">m_plot_scorematrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">m_plot_scorematrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TH2D</span><span class="p">(</span> <span class="s">&quot;h2d_flowmatch_scorematrix&quot;</span><span class="p">,</span> <span class="s">&quot;;Source Contour;Target Contour&quot;</span><span class="p">,</span>
                         <span class="n">m_src_ncontours</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m_src_ncontours</span><span class="p">,</span>
                         <span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">is</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">is</span><span class="o">&lt;</span><span class="n">m_src_ncontours</span><span class="p">;</span> <span class="n">is</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">it</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">it</span><span class="o">&lt;</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">];</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">m_plot_scorematrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">SetBinContent</span><span class="p">(</span> <span class="n">is</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">it</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">][</span> <span class="n">is</span><span class="o">*</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="o">+</span> <span class="n">it</span> <span class="p">]</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">m_plot_scorematrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">SetMaximum</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
    <span class="n">m_plot_scorematrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">SetMinimum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>

    <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">m_plot_scorematrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">_make3Dhits</span><span class="p">(</span> <span class="k">const</span> <span class="n">larlite</span><span class="o">::</span><span class="n">event_hit</span><span class="o">&amp;</span> <span class="n">hit_v</span><span class="p">,</span>
                      <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">srcimg_adc</span><span class="p">,</span>
                      <span class="k">const</span> <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&amp;</span> <span class="n">tar_adc</span><span class="p">,</span>
                      <span class="k">const</span> <span class="kt">int</span> <span class="n">src_plane</span><span class="p">,</span>
                      <span class="k">const</span> <span class="kt">int</span> <span class="n">tar_plane</span><span class="p">,</span>
                      <span class="k">const</span> <span class="kt">float</span> <span class="n">threshold</span><span class="p">,</span>
                      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;&amp;</span> <span class="n">hit2flowdata</span><span class="p">,</span>
                      <span class="k">const</span> <span class="n">FlowDirection_t</span> <span class="n">kflowdir</span> <span class="p">)</span> <span class="p">{</span>

    <span class="c1">// make3Dhits</span>
    <span class="c1">// turn flow predictions and contour matches into 3D hits</span>
    <span class="c1">//</span>
    <span class="c1">// inputs</span>
    <span class="c1">// ------</span>
    <span class="c1">// hit_v: vector of hits found on the different planes</span>
    <span class="c1">// srcimg_adc: source ADC image</span>
    <span class="c1">// tar_adc: target ADC image</span>
    <span class="c1">// src_plane: plane ID of source image</span>
    <span class="c1">// tar_plane: plane ID of target image</span>
    <span class="c1">// threshold: ADC threshold used to determine if landed on pixel w/ charge</span>
    <span class="c1">//</span>
    <span class="c1">// implicit input from class members</span>
    <span class="c1">// ----------------------------------</span>
    <span class="c1">// m_score_matrix: tells us which target contours most strongly associated to cluster (from scoreMatches)</span>
    <span class="c1">// m_flowdata: data of what clusters associated to which (createMatchData)</span>
    <span class="c1">// m_src_img2ctrindex: array mapping (row,col) to contour index for source image (createMatchData)</span>
    <span class="c1">// m_tar_img2ctrindex: array mapping (row,col) to contour index for target image (createMatchData)</span>
    <span class="c1">//</span>
    <span class="c1">// outputs</span>
    <span class="c1">// -------</span>
    <span class="c1">// hit2flowdata: this vector is constant for a whole event image, and gets updated for each sub-image.</span>
    <span class="c1">//   it stores where we think we should put the target hit -- note this might be a modification of the</span>
    <span class="c1">//   the initial flow prediction</span>
    <span class="c1">//</span>
    <span class="c1">// description of method</span>
    <span class="c1">// ---------------------</span>
    <span class="c1">// 1) loop over hits</span>
    <span class="c1">// 2) for each hit, determine if it is within a source contour using m_src_img2ctrindex</span>
    <span class="c1">// 3) using flow image, determine target pixel</span>
    <span class="c1">// 4) determine match quality</span>
    <span class="c1">// 5) depending on match quality, determine matching target column</span>
    <span class="c1">// 6) convert source and target columns into wires, row into ticks</span>
    <span class="c1">// 7) turn that information, make 3D hit position (X-axis relative to trigger time)</span>

    <span class="kt">int</span> <span class="n">_verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">hit2flowdata</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="n">hit_v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">_verbosity</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">)</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;hit2flowdata vector is reset&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
      <span class="n">hit2flowdata</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
      <span class="n">hit2flowdata</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span> <span class="n">hit_v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// for (int hitidx=0; hitidx&lt;(int)hit_v.size(); hitidx++) {</span>
    <span class="c1">//   // get hit for this index</span>
    <span class="c1">//   const larlite::hit&amp; ahit = hit_v[hitidx];</span>
    <span class="c1">//   std::cout &lt;&lt; &quot;hit[&quot; &lt;&lt; hitidx &lt;&lt; &quot;]: &quot; &lt;&lt; ahit.StartTick() &lt;&lt; std::endl;</span>
    <span class="c1">// }</span>
    <span class="c1">// std::cin.get();</span>

    <span class="kt">int</span> <span class="n">numscoredhits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">not_on_src_plane</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">not_in_bounds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">src_col_nomatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">no_contour</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">hitidx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">hitidx</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hit_v</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">hitidx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// get hit for this index</span>
      <span class="k">const</span> <span class="n">larlite</span><span class="o">::</span><span class="n">hit</span><span class="o">&amp;</span> <span class="n">ahit</span> <span class="o">=</span> <span class="n">hit_v</span><span class="p">[</span><span class="n">hitidx</span><span class="p">];</span>

      <span class="c1">// is this on the source plane? if not, skip</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">src_plane</span><span class="o">!=</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ahit</span><span class="p">.</span><span class="n">WireID</span><span class="p">().</span><span class="n">planeID</span><span class="p">().</span><span class="n">Plane</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">not_on_src_plane</span><span class="o">++</span><span class="p">;</span>
    <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// is it in the image (crop)</span>

      <span class="c1">// time limits</span>
      <span class="kt">int</span> <span class="n">hit_tstart</span> <span class="o">=</span> <span class="mi">2400</span><span class="o">+</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ahit</span><span class="p">.</span><span class="n">StartTick</span><span class="p">();</span>
      <span class="kt">int</span> <span class="n">hit_tend</span>   <span class="o">=</span> <span class="mi">2400</span><span class="o">+</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ahit</span><span class="p">.</span><span class="n">EndTick</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">hit_tend</span> <span class="o">&lt;</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">min_y</span><span class="p">()</span> <span class="o">||</span> <span class="n">hit_tstart</span> <span class="o">&gt;=</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">max_y</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// if not within the tick bounds, skip</span>
    <span class="n">not_in_bounds</span><span class="o">++</span><span class="p">;</span>
    <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">hit_tend</span> <span class="o">&gt;=</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">max_y</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">hit_tend</span> <span class="o">=</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">pos_y</span><span class="p">(</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">rows</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span> <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">hit_tstart</span> <span class="o">&lt;</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">min_y</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">hit_tstart</span> <span class="o">=</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">min_y</span><span class="p">();</span>

      <span class="c1">// wire bounds</span>
      <span class="kt">int</span> <span class="n">wire</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ahit</span><span class="p">.</span><span class="n">WireID</span><span class="p">().</span><span class="n">Wire</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">wire</span> <span class="o">&lt;</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">min_x</span><span class="p">()</span> <span class="o">||</span> <span class="n">wire</span> <span class="o">&gt;=</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">max_x</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// if not within wire bounds, skip</span>
    <span class="n">not_in_bounds</span><span class="o">++</span><span class="p">;</span>
    <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>


      <span class="c1">// translate wire and ticks into col and row</span>
      <span class="kt">int</span> <span class="n">wirecol</span>  <span class="o">=</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">col</span><span class="p">(</span> <span class="n">wire</span> <span class="p">);</span>
      <span class="kt">int</span> <span class="n">rowstart</span> <span class="o">=</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">row</span><span class="p">(</span> <span class="n">hit_tstart</span> <span class="p">);</span>
      <span class="kt">int</span> <span class="n">rowend</span>   <span class="o">=</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">row</span><span class="p">(</span> <span class="n">hit_tend</span> <span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">_verbosity</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">)</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;---------------------------------------&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">_verbosity</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">)</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;valid hit: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">hitidx</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; wire=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">wire</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; wirecol=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">wirecol</span>
          <span class="o">&lt;&lt;</span> <span class="s">&quot; tickrange=[&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">hit_tstart</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">hit_tend</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;]&quot;</span>
          <span class="o">&lt;&lt;</span> <span class="s">&quot; rowrange=[&quot;</span>  <span class="o">&lt;&lt;</span> <span class="n">rowstart</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">rowend</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;]&quot;</span>
          <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

      <span class="c1">// ok our hit is in the image. match the hit to a contour</span>
      <span class="c1">// we loop through source image contours and check if any of their pixels are inside the hit tick range.</span>
      <span class="kt">bool</span> <span class="n">foundcontour</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="kt">int</span>  <span class="n">sourcecontourindex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span> <span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="nl">it_ctr</span> <span class="p">:</span> <span class="n">m_src_targets</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">src_ctridx</span> <span class="o">=</span> <span class="n">it_ctr</span><span class="p">.</span><span class="n">first</span><span class="p">;</span> <span class="c1">// source image contour index</span>
    <span class="k">const</span> <span class="n">ContourTargets_t</span><span class="o">&amp;</span> <span class="n">ctrtargets</span> <span class="o">=</span> <span class="n">it_ctr</span><span class="p">.</span><span class="n">second</span><span class="p">;</span> <span class="c1">// list of src and target pixels</span>

    <span class="c1">// loop over pixels within this source contour, find those that fit within given hit above</span>
    <span class="k">for</span> <span class="p">(</span> <span class="k">auto</span> <span class="k">const</span><span class="o">&amp;</span> <span class="nl">pixinfo</span> <span class="p">:</span> <span class="n">ctrtargets</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">//std::cout &lt;&lt; &quot;  srcctr[&quot; &lt;&lt; src_ctridx &lt;&lt; &quot;] (&quot; &lt;&lt; pixinfo.row &lt;&lt; &quot;,&quot; &lt;&lt; pixinfo.srccol &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">wirecol</span><span class="o">!=</span><span class="n">pixinfo</span><span class="p">.</span><span class="n">srccol</span> <span class="p">)</span> <span class="p">{</span>
        <span class="c1">//std::cout &lt;&lt; &quot;source contour pixel does not match, skip. wirecol=&quot; &lt;&lt; wirecol &lt;&lt; &quot; pixinfo.srccol=&quot; &lt;&lt; pixinfo.srccol &lt;&lt; std::endl;</span>
        <span class="n">src_col_nomatch</span><span class="o">++</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">rowstart</span> <span class="o">&lt;=</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span> <span class="o">&amp;&amp;</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span> <span class="o">&lt;=</span> <span class="n">rowend</span> <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// found the overlap</span>
        <span class="n">sourcecontourindex</span> <span class="o">=</span> <span class="n">src_ctridx</span><span class="p">;</span>
        <span class="n">foundcontour</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">_verbosity</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">)</span>
          <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;source contour pixel within hit. source contour=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">src_ctridx</span>
            <span class="o">&lt;&lt;</span> <span class="s">&quot; source(r,c)=(&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">srccol</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;)&quot;</span>
            <span class="o">&lt;&lt;</span> <span class="s">&quot; w/ flow to target(r,c)=(&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">col</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;)&quot;</span>
            <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

        <span class="c1">// update the src/target pix from larflow based on</span>
        <span class="c1">// 1) adc value of source pixel</span>
        <span class="c1">// 2) match quality</span>
        <span class="kt">float</span> <span class="n">src_adc</span>    <span class="o">=</span> <span class="n">srcimg_adc</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">srccol</span> <span class="p">);</span>

        <span class="c1">// match quality</span>
        <span class="c1">// 1-best) target pixel inside (primary?) contour and on charge</span>
        <span class="c1">// 2) target pixel inside contour -- find closest charge inside contour</span>
        <span class="c1">// 3) target pixel outside contour -- find closest charge inside best-score contour</span>
        <span class="c1">// x) can provide a null result too. when truth is in dead region, the resulting hit can often be poor.</span>
        <span class="c1">//    eventually we would use matchability here. alternatively, during tracking pass, we can infer if</span>
        <span class="c1">//    next step is inside dead region. if flow prediction at this point is wildly off, then we throw</span>
        <span class="c1">//    out hit. but there is nothing one can do for that approach here.</span>

        <span class="c1">// get the data for this hit</span>
        <span class="n">HitFlowData_t</span><span class="o">&amp;</span> <span class="n">hitdata</span> <span class="o">=</span> <span class="n">hit2flowdata</span><span class="p">[</span><span class="n">hitidx</span><span class="p">];</span>

        <span class="c1">// so we first calculate the hit quality, using the flow, src image, target image,</span>
        <span class="c1">//  and src-target contour matches (via score matrix)</span>
        <span class="kt">int</span> <span class="n">matchquality</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// &lt;&lt; starting value</span>
        <span class="kt">int</span> <span class="n">pastquality</span>  <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">matchquality</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">dist2center</span>  <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">srccol</span> <span class="o">-</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span> <span class="p">);</span>
        <span class="kt">int</span> <span class="n">dist2charge</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">_verbosity</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">)</span>
          <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  -- past hitquality=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pastquality</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

        <span class="c1">// does target point to charge? look within a range of wires</span>
        <span class="kt">int</span> <span class="n">tarcolmin</span> <span class="o">=</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">col</span><span class="o">-</span><span class="n">kTargetChargeRadius</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">tarcolmax</span> <span class="o">=</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">col</span><span class="o">+</span><span class="n">kTargetChargeRadius</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">tarcolmin</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span>
          <span class="n">tarcolmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">tarcolmax</span><span class="o">&gt;=</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span> <span class="p">)</span>
          <span class="n">tarcolmax</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

        <span class="c1">// we look for the peak adc value between tarcolmin and tarcolmax</span>
        <span class="kt">float</span> <span class="n">target_adc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// &lt;&lt;</span>
        <span class="kt">int</span>   <span class="n">target_col</span> <span class="o">=</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">col</span><span class="p">;</span> <span class="c1">// &lt;&lt; default, set to flow prediction</span>
        <span class="kt">bool</span> <span class="n">oncharge</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">tarcol</span><span class="o">=</span><span class="n">tarcolmin</span><span class="p">;</span> <span class="n">tarcol</span><span class="o">&lt;=</span><span class="n">tarcolmax</span><span class="p">;</span> <span class="n">tarcol</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="kt">float</span> <span class="n">tadc</span> <span class="o">=</span> <span class="n">tar_adc</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="n">tarcol</span> <span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">target_adc</span><span class="o">&lt;</span><span class="n">tadc</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">target_adc</span> <span class="o">=</span> <span class="n">tadc</span><span class="p">;</span>
        <span class="n">target_col</span> <span class="o">=</span> <span class="n">tarcol</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">target_adc</span><span class="o">&gt;</span><span class="n">threshold</span> <span class="p">)</span> <span class="p">{</span>
          <span class="n">oncharge</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// is this pixel in a (matched) contour</span>
        <span class="kt">bool</span> <span class="n">incontour</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">target_contour</span> <span class="o">=</span> <span class="n">m_tar_img2ctrindex</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">][</span> <span class="kt">int</span><span class="p">(</span><span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span><span class="o">*</span><span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span> <span class="o">+</span> <span class="n">target_col</span><span class="p">)</span> <span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">target_contour</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
          <span class="n">incontour</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// CONDITIONS FOR QUALITY LEVEL</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">incontour</span> <span class="o">&amp;&amp;</span> <span class="n">oncharge</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// quality level 1: oncharge and incontour</span>
          <span class="n">matchquality</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="n">dist2charge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">_verbosity</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">)</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  -- hit quality=1 &quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; past(&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pastquality</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span><span class="c1">//end of quality 1 condition</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">incontour</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">oncharge</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pastquality</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">||</span> <span class="n">pastquality</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// quality level 2: incontour but not on charge</span>

          <span class="c1">// we calculate the matched pixel for this case if in the past we didnt get a better match</span>
          <span class="n">matchquality</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">_verbosity</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">)</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  -- hit quality=2 &quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; past(&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pastquality</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

          <span class="c1">// we look for the closest pixel inside the contour that has charge, and that is what we match to</span>
          <span class="kt">int</span> <span class="n">possearch_col</span> <span class="o">=</span> <span class="n">target_col</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">possearch_col</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span>
        <span class="n">possearch_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">possearch_col</span><span class="o">&gt;=</span><span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">possearch_col</span> <span class="o">=</span> <span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

          <span class="k">while</span> <span class="p">(</span> <span class="n">possearch_col</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">possearch_col</span><span class="o">-</span><span class="n">target_col</span><span class="o">&lt;</span><span class="mi">30</span> <span class="o">&amp;&amp;</span> <span class="n">possearch_col</span><span class="o">&gt;</span><span class="n">target_col</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">m_tar_img2ctrindex</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">][</span> <span class="kt">int</span><span class="p">(</span><span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span><span class="o">*</span><span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span> <span class="o">+</span> <span class="n">possearch_col</span><span class="p">)</span> <span class="p">]</span><span class="o">==</span><span class="n">target_contour</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// column in contour</span>
          <span class="kt">float</span> <span class="n">tadc</span> <span class="o">=</span> <span class="n">tar_adc</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="n">possearch_col</span> <span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">tadc</span><span class="o">&gt;</span><span class="n">threshold</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">possearch_col</span><span class="o">++</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="kt">int</span> <span class="n">negsearch_col</span> <span class="o">=</span> <span class="n">target_col</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">negsearch_col</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span>
        <span class="n">negsearch_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">negsearch_col</span><span class="o">&gt;=</span><span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">negsearch_col</span> <span class="o">=</span> <span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

          <span class="k">while</span> <span class="p">(</span> <span class="n">negsearch_col</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">target_col</span><span class="o">-</span><span class="n">negsearch_col</span><span class="o">&lt;</span><span class="mi">30</span> <span class="o">&amp;&amp;</span> <span class="n">negsearch_col</span> <span class="o">&lt;</span> <span class="n">target_col</span>  <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">m_tar_img2ctrindex</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">][</span> <span class="kt">int</span><span class="p">(</span><span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span><span class="o">*</span><span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span> <span class="o">+</span> <span class="n">negsearch_col</span><span class="p">)</span> <span class="p">]</span><span class="o">==</span><span class="n">target_contour</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// column in contour</span>
          <span class="kt">float</span> <span class="n">tadc</span> <span class="o">=</span> <span class="n">tar_adc</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="n">negsearch_col</span> <span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">tadc</span><span class="o">&gt;</span><span class="n">threshold</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">negsearch_col</span><span class="o">--</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="c1">// bound results</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">negsearch_col</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span>
        <span class="n">negsearch_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">possearch_col</span><span class="o">&gt;=</span><span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">possearch_col</span> <span class="o">=</span> <span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

          <span class="kt">int</span> <span class="n">negdist</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">negsearch_col</span><span class="o">-</span><span class="n">target_col</span><span class="p">);</span>
          <span class="kt">int</span> <span class="n">posdist</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">possearch_col</span><span class="o">-</span><span class="n">target_col</span><span class="p">);</span>

          <span class="k">if</span> <span class="p">(</span>  <span class="n">negdist</span> <span class="o">&lt;</span> <span class="n">posdist</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">target_col</span> <span class="o">=</span> <span class="n">negsearch_col</span><span class="p">;</span>
        <span class="n">dist2charge</span> <span class="o">=</span> <span class="n">negdist</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
        <span class="n">target_col</span>  <span class="o">=</span> <span class="n">possearch_col</span><span class="p">;</span>
        <span class="n">dist2charge</span> <span class="o">=</span> <span class="n">posdist</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">target_adc</span> <span class="o">=</span> <span class="n">tar_adc</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="n">target_col</span> <span class="p">);</span>

        <span class="p">}</span><span class="c1">// end of quality 2</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">incontour</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pastquality</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">||</span> <span class="n">pastquality</span><span class="o">&gt;=</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// quality 3: out of contour and out of charge</span>
          <span class="c1">// we calculate the matched pixel for this case if in the past we didnt get a better match</span>
          <span class="c1">// doing the best we can</span>
          <span class="n">matchquality</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">_verbosity</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">)</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  -- hit quality=3 &quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; past(&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pastquality</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;) starting search from target_col=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">target_col</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

          <span class="c1">// check the best matching contour first for charge to match</span>
          <span class="c1">// we search in a neighborhood around the predicted point</span>
          <span class="c1">// we track all the contours we cross into</span>
          <span class="c1">// we use the contour with the best value from m_score_matrix</span>
          <span class="c1">// take the pixel using the best match</span>
          <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ClosestContourPix_t</span><span class="o">&gt;</span> <span class="n">matched_contour_list</span><span class="p">;</span>
          <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">used_contours</span><span class="p">;</span>

          <span class="kt">bool</span> <span class="n">found_candidate_contour</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
          <span class="kt">int</span> <span class="n">possearch_col</span> <span class="o">=</span> <span class="n">target_col</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">possearch_col</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span>
        <span class="n">possearch_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">possearch_col</span><span class="o">&gt;=</span><span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">possearch_col</span> <span class="o">=</span> <span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">while</span> <span class="p">(</span> <span class="n">possearch_col</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">possearch_col</span><span class="o">&gt;</span><span class="n">target_col</span> <span class="o">&amp;&amp;</span> <span class="n">possearch_col</span><span class="o">-</span><span class="n">target_col</span><span class="o">&lt;</span><span class="mi">50</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kt">float</span> <span class="n">tadc</span> <span class="o">=</span> <span class="n">tar_adc</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="n">possearch_col</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">tadc</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="p">)</span>  <span class="p">{</span>
          <span class="kt">int</span> <span class="n">target_contour_idx</span> <span class="o">=</span> <span class="n">m_tar_img2ctrindex</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">][</span> <span class="kt">int</span><span class="p">(</span><span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span><span class="o">*</span><span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span> <span class="o">+</span> <span class="n">possearch_col</span><span class="p">)</span> <span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">used_contours</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">target_contour_idx</span> <span class="p">)</span><span class="o">==</span><span class="n">used_contours</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="c1">// have not search this contour, provide a match candidate</span>
            <span class="n">ClosestContourPix_t</span> <span class="n">close_ctr_info</span><span class="p">;</span>
            <span class="n">close_ctr_info</span><span class="p">.</span><span class="n">ctridx</span> <span class="o">=</span> <span class="n">target_contour_idx</span><span class="p">;</span>
            <span class="n">close_ctr_info</span><span class="p">.</span><span class="n">dist</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">possearch_col</span> <span class="o">-</span> <span class="n">target_col</span><span class="p">);</span>
            <span class="n">close_ctr_info</span><span class="p">.</span><span class="n">col</span>  <span class="o">=</span> <span class="n">possearch_col</span><span class="p">;</span>
            <span class="n">close_ctr_info</span><span class="p">.</span><span class="n">adc</span>  <span class="o">=</span> <span class="n">tadc</span><span class="p">;</span>
            <span class="n">close_ctr_info</span><span class="p">.</span><span class="n">scorematch</span> <span class="o">=</span> <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">][</span> <span class="kt">int</span><span class="p">(</span><span class="n">src_ctridx</span><span class="o">*</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="o">+</span> <span class="n">target_contour_idx</span><span class="p">)</span> <span class="p">];</span>
            <span class="n">matched_contour_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">close_ctr_info</span> <span class="p">);</span>
            <span class="n">used_contours</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">target_contour_idx</span> <span class="p">);</span>
            <span class="n">found_candidate_contour</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">possearch_col</span><span class="o">++</span><span class="p">;</span>
          <span class="p">}</span><span class="c1">//end of pos loop</span>
          <span class="kt">int</span> <span class="n">negsearch_col</span> <span class="o">=</span> <span class="n">target_col</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">negsearch_col</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span>
        <span class="n">negsearch_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">negsearch_col</span><span class="o">&gt;=</span><span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">negsearch_col</span> <span class="o">=</span> <span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">while</span> <span class="p">(</span> <span class="n">negsearch_col</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">target_col</span><span class="o">-</span><span class="n">negsearch_col</span><span class="o">&lt;</span><span class="mi">50</span> <span class="o">&amp;&amp;</span> <span class="n">negsearch_col</span> <span class="o">&lt;</span> <span class="n">target_col</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">float</span> <span class="n">tadc</span> <span class="o">=</span> <span class="n">tar_adc</span><span class="p">.</span><span class="n">pixel</span><span class="p">(</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="n">negsearch_col</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span>  <span class="n">tadc</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="p">)</span>  <span class="p">{</span>
          <span class="kt">int</span> <span class="n">target_contour_idx</span> <span class="o">=</span> <span class="n">m_tar_img2ctrindex</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">][</span> <span class="kt">int</span><span class="p">(</span><span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span><span class="o">*</span><span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cols</span><span class="p">()</span> <span class="o">+</span> <span class="n">negsearch_col</span><span class="p">)</span> <span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">used_contours</span><span class="p">.</span><span class="n">find</span><span class="p">(</span> <span class="n">target_contour_idx</span> <span class="p">)</span><span class="o">==</span><span class="n">used_contours</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="c1">// have not search this contour, provide a match candidate</span>
            <span class="n">ClosestContourPix_t</span> <span class="n">close_ctr_info</span><span class="p">;</span>
            <span class="n">close_ctr_info</span><span class="p">.</span><span class="n">ctridx</span> <span class="o">=</span> <span class="n">target_contour_idx</span><span class="p">;</span>
            <span class="n">close_ctr_info</span><span class="p">.</span><span class="n">dist</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">negsearch_col</span> <span class="o">-</span> <span class="n">target_col</span><span class="p">);</span>
            <span class="n">close_ctr_info</span><span class="p">.</span><span class="n">col</span>  <span class="o">=</span> <span class="n">negsearch_col</span><span class="p">;</span>
            <span class="n">close_ctr_info</span><span class="p">.</span><span class="n">adc</span>  <span class="o">=</span> <span class="n">tadc</span><span class="p">;</span>
            <span class="n">close_ctr_info</span><span class="p">.</span><span class="n">scorematch</span> <span class="o">=</span> <span class="n">m_score_matrix</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">][</span> <span class="n">src_ctridx</span><span class="o">*</span><span class="n">m_tar_ncontours</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span> <span class="o">+</span> <span class="n">target_contour_idx</span> <span class="p">];</span>
            <span class="n">matched_contour_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span> <span class="n">close_ctr_info</span> <span class="p">);</span>
            <span class="n">used_contours</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">target_contour_idx</span> <span class="p">);</span>
            <span class="n">found_candidate_contour</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">negsearch_col</span><span class="o">--</span><span class="p">;</span>
          <span class="p">}</span><span class="c1">//end of neg loop</span>

          <span class="c1">// ok, now we pick the best one! if we found a candidate that is</span>
          <span class="kt">float</span> <span class="n">best_score</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="kt">float</span> <span class="n">best_adc</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
          <span class="kt">int</span> <span class="n">best_col</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="kt">int</span> <span class="n">best_dist</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">found_candidate_contour</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">match</span> <span class="p">:</span> <span class="n">matched_contour_list</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">best_score</span> <span class="o">&lt;</span> <span class="n">match</span><span class="p">.</span><span class="n">scorematch</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">best_col</span>   <span class="o">=</span> <span class="n">match</span><span class="p">.</span><span class="n">col</span><span class="p">;</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="n">match</span><span class="p">.</span><span class="n">scorematch</span><span class="p">;</span>
            <span class="n">best_dist</span>  <span class="o">=</span> <span class="n">match</span><span class="p">.</span><span class="n">dist</span><span class="p">;</span>
            <span class="n">best_adc</span>   <span class="o">=</span> <span class="n">match</span><span class="p">.</span><span class="n">adc</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">target_col</span>  <span class="o">=</span> <span class="n">best_col</span><span class="p">;</span>
        <span class="n">dist2charge</span> <span class="o">=</span> <span class="n">best_dist</span><span class="p">;</span>
        <span class="n">target_adc</span>  <span class="o">=</span> <span class="n">best_adc</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// didn&#39;t find a nearby contour</span>
        <span class="n">target_col</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// indicates that no good target found</span>
        <span class="n">matchquality</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// did we do better?</span>
        <span class="kt">bool</span> <span class="n">update_hitdata</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">matchquality</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">target_col</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// target_col&lt;0 indicates no good target found (happens when true target pixel in dead region)</span>
          <span class="c1">//we found a case where we did better or the same</span>

          <span class="k">if</span> <span class="p">(</span> <span class="n">matchquality</span><span class="o">&lt;</span><span class="n">pastquality</span> <span class="o">||</span> <span class="n">pastquality</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span>  <span class="p">{</span>
        <span class="c1">// we did better. replace the hit</span>
        <span class="n">update_hitdata</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">matchquality</span><span class="o">==</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">dist2center</span><span class="o">&gt;</span><span class="n">dist2center</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// we decide on this by using the src pixel closest to the center of the y-image</span>
          <span class="n">update_hitdata</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">matchquality</span><span class="o">==</span><span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">dist2charge</span><span class="o">&gt;</span><span class="n">dist2charge</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// we decide on this by using which flow prediction was closest to the eventual charge match</span>
          <span class="n">update_hitdata</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">matchquality</span><span class="o">==</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">dist2charge</span><span class="o">&gt;</span><span class="n">dist2charge</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// same criterion as 2</span>
          <span class="n">update_hitdata</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
          <span class="p">}</span>

        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">matchquality</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pastquality</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
          <span class="c1">// matchquality is currenly not set still (didn&#39;t find a good match)</span>
          <span class="c1">// we want to set the default to for the hitdata</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">maxamp</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">hitidx</span>       <span class="o">=</span> <span class="n">hitidx</span><span class="p">;</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">srcwire</span>      <span class="o">=</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">pos_x</span><span class="p">(</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">srccol</span> <span class="p">);</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">targetwire</span>   <span class="o">=</span> <span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pos_x</span><span class="p">(</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">col</span> <span class="p">);</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">pixtick</span>      <span class="o">=</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">pos_y</span><span class="p">(</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span> <span class="p">);</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">matchquality</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">dist2center</span>  <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>  <span class="c1">// large sentinal value</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">dist2charge</span>  <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>  <span class="c1">// large sentinal value</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">src_ctr_idx</span>  <span class="o">=</span> <span class="n">sourcecontourindex</span><span class="p">;</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">tar_ctr_idx</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">_verbosity</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">)</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  -- set default for unmatched hit [srccol=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">srccol</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;] [targetcol=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">col</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;]&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>


        <span class="k">if</span> <span class="p">(</span> <span class="n">update_hitdata</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">_verbosity</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">)</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  -- update hit flow data&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">maxamp</span>       <span class="o">=</span> <span class="n">target_adc</span><span class="p">;</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">hitidx</span>       <span class="o">=</span> <span class="n">hitidx</span><span class="p">;</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">srcwire</span>      <span class="o">=</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">pos_x</span><span class="p">(</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">srccol</span> <span class="p">);</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">targetwire</span>   <span class="o">=</span> <span class="n">m_tarimg_meta</span><span class="p">[</span><span class="n">kflowdir</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pos_x</span><span class="p">(</span> <span class="n">target_col</span> <span class="p">);</span> <span class="c1">//&lt; we used the column we found</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">pixtick</span>      <span class="o">=</span> <span class="n">m_srcimg_meta</span><span class="o">-&gt;</span><span class="n">pos_y</span><span class="p">(</span> <span class="n">pixinfo</span><span class="p">.</span><span class="n">row</span> <span class="p">);</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">matchquality</span> <span class="o">=</span> <span class="n">matchquality</span><span class="p">;</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">dist2center</span>  <span class="o">=</span> <span class="n">dist2center</span><span class="p">;</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">dist2charge</span>  <span class="o">=</span> <span class="n">dist2charge</span><span class="p">;</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">src_ctr_idx</span>  <span class="o">=</span> <span class="n">sourcecontourindex</span><span class="p">;</span>
          <span class="n">hitdata</span><span class="p">.</span><span class="n">tar_ctr_idx</span>  <span class="o">=</span> <span class="n">target_contour</span><span class="p">;</span>
        <span class="p">}</span>

      <span class="p">}</span><span class="c1">//if row within hit row range</span>
    <span class="p">}</span><span class="c1">//end of ctrtargets pixel loop</span>

      <span class="p">}</span><span class="c1">//end of loop over list of src-target pairs</span>

      <span class="c1">// did it find a source contour?</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">foundcontour</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">_verbosity</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">)</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;pixel src(r,c)=(&quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">rowstart</span><span class="o">+</span><span class="n">rowend</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">wirecol</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;) does not have matching source contour.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">no_contour</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
    <span class="n">numscoredhits</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>

    <span class="p">}</span><span class="c1">//end of hit index loop</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;number of scored hits: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">numscoredhits</span>
          <span class="o">&lt;&lt;</span> <span class="s">&quot; (no_contour=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">no_contour</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
          <span class="o">&lt;&lt;</span> <span class="s">&quot; src_col_nomatch=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">src_col_nomatch</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
          <span class="o">&lt;&lt;</span> <span class="s">&quot; not_in_bounds=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">not_in_bounds</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
          <span class="o">&lt;&lt;</span> <span class="s">&quot; not_on_srcplane=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">not_on_src_plane</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;)&quot;</span>
          <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">&gt;</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">get3Dhits_1pl</span><span class="p">(</span> <span class="n">FlowDirection_t</span> <span class="n">flowdir</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">makehits_for_nonmatches</span> <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// we convert the information we&#39;ve compiled in m_hit2flowdata, which provides our best guess</span>
    <span class="c1">//  as the correct source-column + target-column pair.</span>
    <span class="c1">//  the objects of this container also contain info about matchquality</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">flowdir</span><span class="o">==</span><span class="n">kY2U</span> <span class="p">)</span>
      <span class="k">return</span> <span class="n">get3Dhits_1pl</span><span class="p">(</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">Y2U</span><span class="p">,</span> <span class="n">makehits_for_nonmatches</span> <span class="p">);</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span> <span class="n">flowdir</span><span class="o">==</span><span class="n">kY2V</span> <span class="p">)</span>
      <span class="k">return</span> <span class="n">get3Dhits_1pl</span><span class="p">(</span> <span class="n">m_plhit2flowdata</span><span class="p">.</span><span class="n">Y2U</span><span class="p">,</span> <span class="n">makehits_for_nonmatches</span> <span class="p">);</span>
    <span class="k">else</span>
      <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;should not get here&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">&gt;</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">get3Dhits_1pl</span><span class="p">(</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;&amp;</span> <span class="n">hit2flowdata</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">makehits_for_nonmatches</span> <span class="p">)</span> <span class="p">{</span>

    <span class="c1">// now we have, in principle, the best/modified flow prediction for hits that land on flow predictions</span>
    <span class="c1">// we can make 3D hits!</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">&gt;</span> <span class="n">output_hit3d_v</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">hitidx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">hitidx</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hit2flowdata</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">hitidx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const</span> <span class="n">HitFlowData_t</span><span class="o">&amp;</span> <span class="n">hitdata</span> <span class="o">=</span> <span class="n">hit2flowdata</span><span class="p">[</span> <span class="n">hitidx</span> <span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span>  <span class="n">hitdata</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">makehits_for_nonmatches</span> <span class="p">)</span> <span class="p">{</span>
    <span class="c1">//std::cout &lt;&lt; &quot;no good match for hitidx=&quot; &lt;&lt; hitidx &lt;&lt; &quot;, skip this hit if we haven&#39;t set the makehits_for_nonmatches flag&quot; &lt;&lt; std::endl;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// otherwise make a hit</span>
      <span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span> <span class="n">flowhit</span><span class="p">;</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">idxhit</span>     <span class="o">=</span> <span class="n">hitidx</span><span class="p">;</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">tick</span>       <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">pixtick</span><span class="p">;</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">srcwire</span>    <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">srcwire</span><span class="p">;</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">targetwire</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">targetwire</span><span class="p">;</span>
      <span class="n">flowhit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">flowhit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>          <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">flowhit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>          <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">dy</span>            <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="p">;</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">dz</span>            <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="p">;</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">consistency3d</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kNoValue</span><span class="p">;</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>    <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">trackid</span>       <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">trackid</span><span class="p">;</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">dWall</span>         <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">dWall</span><span class="p">;</span>
      <span class="k">switch</span> <span class="p">(</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">matchquality</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">matchquality</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kQandCmatch</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">matchquality</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kCmatch</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">matchquality</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kClosestC</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">matchquality</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kNoMatch</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">switch</span> <span class="p">(</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">truthflag</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">truthflag</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kNoTruthMatch</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">truthflag</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kOnTrack</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">truthflag</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kOnSmear</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">truthflag</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kUnknown</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">output_hit3d_v</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span> <span class="n">flowhit</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">output_hit3d_v</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">&gt;</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">get3Dhits_2pl</span><span class="p">(</span> <span class="kt">bool</span> <span class="n">makehits_for_nonmatches</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">require_3Dconsistency</span> <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// we convert the information we&#39;ve compiled in m_hit2flowdata, which provides our best guess</span>
    <span class="c1">//  as the correct source-column + target-column pair.</span>
    <span class="c1">//  the objects of this container also contain info about matchquality</span>
      <span class="k">return</span> <span class="n">get3Dhits_2pl</span><span class="p">(</span> <span class="n">m_plhit2flowdata</span><span class="p">,</span> <span class="n">makehits_for_nonmatches</span><span class="p">,</span> <span class="n">require_3Dconsistency</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">&gt;</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">get3Dhits_2pl</span><span class="p">(</span> <span class="k">const</span> <span class="n">PlaneHitFlowData_t</span><span class="o">&amp;</span> <span class="n">plhit2flowdata</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">makehits_for_nonmatches</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">require_3Dconsistency</span> <span class="p">)</span> <span class="p">{</span>

    <span class="c1">// now we have, in principle, the best/modified flow prediction for hits that land on flow predictions</span>
    <span class="c1">// here we choose which of the two predictions to keep (for each hit)</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">&gt;</span> <span class="n">output_hit3d_v</span><span class="p">;</span>

    <span class="c1">// case 1, we only ran one flow direction</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">ranY2U</span> <span class="o">||</span> <span class="o">!</span><span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">ranY2V</span> <span class="p">)</span> <span class="p">{</span>

      <span class="c1">// determine which one we ran</span>
      <span class="n">FlowDirection_t</span> <span class="n">flowdir</span> <span class="o">=</span> <span class="p">(</span> <span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">ranY2U</span> <span class="p">)</span> <span class="o">?</span> <span class="nl">kY2U</span> <span class="p">:</span> <span class="n">kY2V</span><span class="p">;</span>
      <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;&amp;</span> <span class="n">hit2flowdata</span> <span class="o">=</span> <span class="p">(</span> <span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">ranY2U</span> <span class="p">)</span> <span class="o">?</span> <span class="n">plhit2flowdata</span><span class="p">.</span><span class="nl">Y2U</span> <span class="p">:</span> <span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">Y2V</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">hitidx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">hitidx</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hit2flowdata</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">hitidx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">HitFlowData_t</span><span class="o">&amp;</span> <span class="n">hitdata</span> <span class="o">=</span> <span class="n">hit2flowdata</span><span class="p">[</span> <span class="n">hitidx</span> <span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span>  <span class="n">hitdata</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">makehits_for_nonmatches</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">//std::cout &lt;&lt; &quot;no good match for hitidx=&quot; &lt;&lt; hitidx &lt;&lt; &quot;, skip this hit if we haven&#39;t set the makehits_for_nonmatches flag&quot; &lt;&lt; std::endl;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// otherwise make a hit</span>
    <span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span> <span class="n">flowhit</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">idxhit</span>        <span class="o">=</span> <span class="n">hitidx</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">tick</span>          <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">pixtick</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">srcwire</span>       <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">srcwire</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">targetwire</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">targetwire</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>            <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">flowhit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>            <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">flowhit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>            <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">dy</span>            <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// no 3d consistency calc</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">dz</span>            <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// no 3d consistency calc</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">track_score</span>   <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">track_score</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">shower_score</span>  <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">shower_score</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">endpt_score</span>   <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">endpt_score</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">renormed_track_score</span>   <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">renormed_track_score</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">renormed_shower_score</span>  <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">renormed_shower_score</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">src_infill</span>    <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">hitdata</span><span class="p">.</span><span class="n">src_infill</span><span class="p">);</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">tar_infill</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">hitdata</span><span class="p">.</span><span class="n">tar_infill</span><span class="p">);</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>    <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">trackid</span>       <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">trackid</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">dWall</span>         <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">dWall</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">matchquality</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">matchquality</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kQandCmatch</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">matchquality</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kCmatch</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">matchquality</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kClosestC</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">matchquality</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kNoMatch</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">consistency3d</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kNoValue</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">truthflag</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">truthflag</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kNoTruthMatch</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">truthflag</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kOnTrack</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">truthflag</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kOnSmear</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">truthflag</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kUnknown</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">output_hit3d_v</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span> <span class="n">flowhit</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="c1">// end of only 1 ran</span>
    <span class="c1">//case 2: we ran Y2U and Y2V</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">ranY2U</span> <span class="o">&amp;&amp;</span> <span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">ranY2V</span><span class="p">){</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Picking hits using 2-flow information&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
      <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;&amp;</span> <span class="n">hit2flowdata_y2u</span> <span class="o">=</span> <span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">Y2U</span><span class="p">;</span>
      <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">HitFlowData_t</span><span class="o">&gt;&amp;</span> <span class="n">hit2flowdata_y2v</span> <span class="o">=</span> <span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">Y2V</span><span class="p">;</span>
      <span class="c1">//we only loop over length of one, they should be same anyway</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">hitidx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">hitidx</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hit2flowdata_y2u</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">hitidx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">HitFlowData_t</span><span class="o">&amp;</span> <span class="n">hitdata0</span> <span class="o">=</span> <span class="n">hit2flowdata_y2u</span><span class="p">[</span> <span class="n">hitidx</span> <span class="p">];</span>
    <span class="k">const</span> <span class="n">HitFlowData_t</span><span class="o">&amp;</span> <span class="n">hitdata1</span> <span class="o">=</span> <span class="n">hit2flowdata_y2v</span><span class="p">[</span> <span class="n">hitidx</span> <span class="p">];</span>
    <span class="n">HitFlowData_t</span> <span class="n">hitdata</span><span class="p">;</span>
    <span class="c1">//select here</span>
    <span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">FlowDirection_t</span> <span class="n">used_dir</span> <span class="o">=</span> <span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kY2U</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">require_3Dconsistency</span> <span class="o">&amp;&amp;</span> <span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">consistency3d</span><span class="p">[</span> <span class="n">hitidx</span> <span class="p">]</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">//if require_3Dconsistency, skip if no consistency</span>
    <span class="k">if</span><span class="p">(</span><span class="n">hitdata0</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata1</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">makehits_for_nonmatches</span> <span class="p">)</span> <span class="p">{</span>
      <span class="c1">//std::cout &lt;&lt; &quot;no good match for hitidx=&quot; &lt;&lt; hitidx &lt;&lt; &quot;, skip this hit if we haven&#39;t set the makehits_for_nonmatches flag&quot; &lt;&lt; std::endl;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">hitdata0</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata1</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">makehits_for_nonmatches</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//neither has a match. pick the one that does not land on infill</span>
      <span class="k">if</span><span class="p">(</span><span class="n">hitdata0</span><span class="p">.</span><span class="n">tar_infill</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hitdata1</span><span class="p">.</span><span class="n">tar_infill</span><span class="p">){</span>
        <span class="n">hitdata</span> <span class="o">=</span> <span class="n">hitdata1</span><span class="p">;</span>
        <span class="n">used_dir</span> <span class="o">=</span> <span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kY2V</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">hitdata0</span><span class="p">.</span><span class="n">tar_infill</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata1</span><span class="p">.</span><span class="n">tar_infill</span><span class="p">){</span>
        <span class="n">hitdata</span> <span class="o">=</span> <span class="n">hitdata0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>
        <span class="n">hitdata</span> <span class="o">=</span> <span class="n">hitdata0</span><span class="p">;</span> <span class="c1">//neither has a match, same infill, pick y2u</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">hitdata0</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata1</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata0</span><span class="p">.</span><span class="n">matchquality</span><span class="o">==</span><span class="n">hitdata1</span><span class="p">.</span><span class="n">matchquality</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//same quality, pick the one that does not land on infill</span>
      <span class="k">if</span><span class="p">(</span><span class="n">hitdata0</span><span class="p">.</span><span class="n">tar_infill</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hitdata1</span><span class="p">.</span><span class="n">tar_infill</span><span class="p">){</span>
        <span class="n">hitdata</span> <span class="o">=</span> <span class="n">hitdata1</span><span class="p">;</span>
        <span class="n">used_dir</span> <span class="o">=</span> <span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kY2V</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">hitdata0</span><span class="p">.</span><span class="n">tar_infill</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hitdata1</span><span class="p">.</span><span class="n">tar_infill</span><span class="p">){</span>
        <span class="n">hitdata</span> <span class="o">=</span> <span class="n">hitdata0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>
        <span class="n">hitdata</span> <span class="o">=</span> <span class="n">hitdata0</span><span class="p">;</span> <span class="c1">//same infill, pick y2u</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">hitdata0</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata1</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
        <span class="o">||</span> <span class="p">(</span><span class="n">hitdata0</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata1</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata0</span><span class="p">.</span><span class="n">matchquality</span> <span class="o">&lt;</span> <span class="n">hitdata1</span><span class="p">.</span><span class="n">matchquality</span><span class="p">))</span>  <span class="p">{</span>
      <span class="n">hitdata</span> <span class="o">=</span> <span class="n">hitdata1</span><span class="p">;</span> <span class="c1">//y2v better matchqual</span>
      <span class="n">used_dir</span> <span class="o">=</span> <span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kY2V</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">hitdata1</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata0</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
        <span class="o">||</span> <span class="p">(</span><span class="n">hitdata1</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata0</span><span class="p">.</span><span class="n">matchquality</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hitdata1</span><span class="p">.</span><span class="n">matchquality</span> <span class="o">&lt;</span> <span class="n">hitdata0</span><span class="p">.</span><span class="n">matchquality</span><span class="p">))</span>  <span class="p">{</span>
      <span class="n">hitdata</span> <span class="o">=</span> <span class="n">hitdata0</span><span class="p">;</span> <span class="c1">//y2u better matchqual</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
      <span class="n">hitdata</span> <span class="o">=</span> <span class="n">hitdata0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//make a hit</span>
    <span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span> <span class="n">flowhit</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">idxhit</span>     <span class="o">=</span> <span class="n">hitidx</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">tick</span>       <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">pixtick</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">srcwire</span>    <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">srcwire</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">flowdir</span>    <span class="o">=</span> <span class="n">used_dir</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">targetwire</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hitdata0</span><span class="p">.</span><span class="n">targetwire</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">targetwire</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hitdata1</span><span class="p">.</span><span class="n">targetwire</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>            <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">flowhit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>            <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">flowhit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>            <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">dy</span>            <span class="o">=</span> <span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">dy</span><span class="p">[</span> <span class="n">hitidx</span> <span class="p">];</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">dz</span>            <span class="o">=</span> <span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">dz</span><span class="p">[</span> <span class="n">hitidx</span> <span class="p">];</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">track_score</span>   <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">track_score</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">shower_score</span>  <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">shower_score</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">endpt_score</span>   <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">endpt_score</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">renormed_track_score</span>   <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">renormed_track_score</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">renormed_shower_score</span>  <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">renormed_shower_score</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">src_infill</span>    <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">hitdata</span><span class="p">.</span><span class="n">src_infill</span><span class="p">);</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">tar_infill</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">hitdata0</span><span class="p">.</span><span class="n">tar_infill</span><span class="p">);</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">tar_infill</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">hitdata1</span><span class="p">.</span><span class="n">tar_infill</span><span class="p">);</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>    <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">X_truth</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">trackid</span>       <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">trackid</span><span class="p">;</span>
    <span class="n">flowhit</span><span class="p">.</span><span class="n">dWall</span>         <span class="o">=</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">dWall</span><span class="p">;</span>
    <span class="c1">//std::cout &lt;&lt;&quot;hitdata dWall &quot;&lt;&lt; hitdata.dWall &lt;&lt;&quot; flowhit dWall &quot; &lt;&lt; flowhit.dWall &lt;&lt; std::endl;</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">matchquality</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">matchquality</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kQandCmatch</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">matchquality</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kCmatch</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">matchquality</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kClosestC</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">matchquality</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kNoMatch</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="n">plhit2flowdata</span><span class="p">.</span><span class="n">consistency3d</span><span class="p">[</span> <span class="n">hitidx</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">consistency3d</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kIn5mm</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">consistency3d</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kIn10mm</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">consistency3d</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kIn50mm</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">consistency3d</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kOut50mm</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">consistency3d</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kNoValue</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="n">hitdata</span><span class="p">.</span><span class="n">truthflag</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">truthflag</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kNoTruthMatch</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">truthflag</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kOnTrack</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">truthflag</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kOnSmear</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="n">flowhit</span><span class="p">.</span><span class="n">truthflag</span><span class="o">=</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kUnknown</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">output_hit3d_v</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span> <span class="n">flowhit</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="c1">// end of both ran</span>

    <span class="k">return</span> <span class="n">output_hit3d_v</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;</span> <span class="n">FlowContourMatch</span><span class="o">::</span><span class="n">makeStitchedFlowImages</span><span class="p">(</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;&amp;</span> <span class="n">img_v</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span> <span class="o">&gt;</span> <span class="n">hit_v</span> <span class="o">=</span> <span class="n">get3Dhits_2pl</span><span class="p">(</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span> <span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span><span class="o">&gt;</span> <span class="n">outimg_v</span><span class="p">;</span>

    <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span> <span class="n">y2uimg</span><span class="p">(</span> <span class="n">img_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">()</span> <span class="p">);</span>
    <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span> <span class="n">y2vimg</span><span class="p">(</span> <span class="n">img_v</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">meta</span><span class="p">()</span> <span class="p">);</span>
    <span class="n">larcv</span><span class="o">::</span><span class="n">Image2D</span> <span class="n">srcimg</span><span class="p">(</span> <span class="n">img_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">meta</span><span class="p">()</span> <span class="p">);</span>
    <span class="n">y2uimg</span><span class="p">.</span><span class="n">paint</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
    <span class="n">y2vimg</span><span class="p">.</span><span class="n">paint</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
    <span class="n">srcimg</span><span class="p">.</span><span class="n">paint</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;[FlowContourMatch::makeStichedFlowImages] start&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;  &quot;</span> <span class="o">&lt;&lt;</span><span class="n">img_v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">dump</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">hit</span> <span class="p">:</span> <span class="n">hit_v</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">hit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">hit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">hit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">// bad hit</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">hit</span><span class="p">.</span><span class="n">tick</span> <span class="o">&gt;=</span><span class="n">img_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">min_y</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">hit</span><span class="p">.</span><span class="n">tick</span><span class="o">&lt;</span><span class="n">img_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">max_y</span><span class="p">()</span>
       <span class="o">&amp;&amp;</span> <span class="n">hit</span><span class="p">.</span><span class="n">srcwire</span><span class="o">&gt;=</span><span class="n">img_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">min_x</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">hit</span><span class="p">.</span><span class="n">srcwire</span><span class="o">&lt;</span><span class="n">img_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">max_x</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">img_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">row</span><span class="p">(</span> <span class="n">hit</span><span class="p">.</span><span class="n">tick</span> <span class="p">);</span>
    <span class="kt">int</span> <span class="n">col</span> <span class="o">=</span> <span class="n">img_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">col</span><span class="p">(</span> <span class="n">hit</span><span class="p">.</span><span class="n">srcwire</span> <span class="p">);</span>
    <span class="c1">//std::cout &lt;&lt; &quot;hit: src(&quot; &lt;&lt; row &lt;&lt; &quot;,&quot; &lt;&lt; col &lt;&lt; &quot;)&quot;;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">hit</span><span class="p">.</span><span class="n">flowdir</span><span class="o">==</span><span class="n">larlite</span><span class="o">::</span><span class="n">larflow3dhit</span><span class="o">::</span><span class="n">kY2U</span> <span class="p">)</span>  <span class="p">{</span>
      <span class="n">srcimg</span><span class="p">.</span><span class="n">set_pixel</span><span class="p">(</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">hit</span><span class="p">.</span><span class="n">targetwire</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">hit</span><span class="p">.</span><span class="n">srcwire</span> <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">img_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">min_x</span><span class="p">()</span><span class="o">&lt;=</span><span class="n">hit</span><span class="p">.</span><span class="n">targetwire</span><span class="p">[</span><span class="n">kY2U</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">img_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">max_x</span><span class="p">()</span><span class="o">&gt;</span><span class="n">hit</span><span class="p">.</span><span class="n">targetwire</span><span class="p">[</span><span class="n">kY2U</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">y2uimg</span><span class="p">.</span><span class="n">set_pixel</span><span class="p">(</span> <span class="n">row</span><span class="p">,</span> <span class="n">img_v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">col</span><span class="p">(</span><span class="n">hit</span><span class="p">.</span><span class="n">targetwire</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">img_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">)</span> <span class="p">);</span>
        <span class="c1">//std::cout &lt;&lt; &quot; target(&quot; &lt;&lt; row &lt;&lt; &quot;,&quot; &lt;&lt; img_v[0].meta().col(hit.targetwire[0]) &lt;&lt; &quot;)&quot;;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">srcimg</span><span class="p">.</span><span class="n">set_pixel</span><span class="p">(</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">hit</span><span class="p">.</span><span class="n">targetwire</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hit</span><span class="p">.</span><span class="n">srcwire</span> <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">img_v</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">min_x</span><span class="p">()</span><span class="o">&lt;=</span><span class="n">hit</span><span class="p">.</span><span class="n">targetwire</span><span class="p">[</span><span class="n">kY2V</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">img_v</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">max_x</span><span class="p">()</span><span class="o">&gt;</span><span class="n">hit</span><span class="p">.</span><span class="n">targetwire</span><span class="p">[</span><span class="n">kY2V</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">y2vimg</span><span class="p">.</span><span class="n">set_pixel</span><span class="p">(</span> <span class="n">row</span><span class="p">,</span> <span class="n">img_v</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">meta</span><span class="p">().</span><span class="n">col</span><span class="p">(</span><span class="n">hit</span><span class="p">.</span><span class="n">targetwire</span><span class="p">[</span><span class="n">kY2V</span><span class="p">]),</span> <span class="n">img_v</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">pixel</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">)</span> <span class="p">);</span>
        <span class="c1">//std::cout &lt;&lt; &quot; target(&quot; &lt;&lt; row &lt;&lt; &quot;,&quot; &lt;&lt; img_v[1].meta().col(hit.targetwire[1]) &lt;&lt; &quot;)&quot;;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//std::cout &lt;&lt; std::endl;</span>

      <span class="p">}</span><span class="c1">// if inside image</span>
    <span class="p">}</span><span class="c1">// hit loop</span>

    <span class="n">outimg_v</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">y2uimg</span><span class="p">)</span> <span class="p">);</span>
    <span class="n">outimg_v</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">y2vimg</span><span class="p">)</span> <span class="p">);</span>
    <span class="n">outimg_v</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">srcimg</span><span class="p">)</span> <span class="p">);</span>

    <span class="k">return</span> <span class="n">outimg_v</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, NuTufts

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>